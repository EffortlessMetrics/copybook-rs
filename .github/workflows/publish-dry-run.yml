# SPDX-License-Identifier: AGPL-3.0-or-later
name: Publish Dry Run

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to test (e.g., v0.3.1)'
        required: false
        type: string

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  publish-dry-run:
    name: Publish Dry Run
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v6
      with:
        fetch-depth: 0
        ref: ${{ inputs.tag || github.ref }}

    - uses: dtolnay/rust-toolchain@stable

    - uses: Swatinem/rust-cache@v2
      with:
        key: publish-dry-run

    - name: Verify ref context
      run: |
        echo "Testing publish preflight for ref: ${{ inputs.tag || github.ref_name }}"
        git rev-parse HEAD
        git describe --tags --always

    - name: Dry run publish (leaf crates)
      run: |
        echo "=== Dry-run publish for leaf crates (no workspace deps) ==="

        # Level 0: No internal dependencies
        for crate in \
          copybook-error \
          copybook-determinism \
          copybook-dialect \
          copybook-codepage \
          copybook-contracts \
          copybook-support-matrix \
          copybook-sequence-ring; do
          echo "Testing ${crate}..."
          cargo publish -p "${crate}" --dry-run
          echo "  ${crate} dry-run successful"
        done

    - name: Package manifest check (all publishable crates)
      run: |
        echo "=== Package manifest check for all 25 publishable crates ==="

        # All publishable crates in dependency order
        for crate in \
          copybook-error \
          copybook-determinism \
          copybook-dialect \
          copybook-codepage \
          copybook-contracts \
          copybook-support-matrix \
          copybook-sequence-ring \
          copybook-overflow \
          copybook-error-reporter \
          copybook-charset \
          copybook-governance-contracts \
          copybook-codec-memory \
          copybook-overpunch \
          copybook-utils \
          copybook-governance-grid \
          copybook-options \
          copybook-governance-runtime \
          copybook-core \
          copybook-governance \
          copybook-fixed \
          copybook-rdw \
          copybook-record-io \
          copybook-codec \
          copybook-arrow \
          copybook-cli; do
          echo "Checking ${crate}..."
          cargo package -p "${crate}" --list > /dev/null
          echo "  ${crate} package file list OK"
        done

    - name: Summary
      if: success()
      run: |
        echo "Publish preflight checks passed!"
        echo ""
        echo "Validated 25 publishable crates:"
        echo "  Level 0 (7): copybook-error, copybook-determinism, copybook-dialect,"
        echo "               copybook-codepage, copybook-contracts, copybook-support-matrix,"
        echo "               copybook-sequence-ring"
        echo "  Level 1 (6): copybook-overflow, copybook-error-reporter, copybook-charset,"
        echo "               copybook-governance-contracts, copybook-codec-memory, copybook-overpunch"
        echo "  Level 2 (3): copybook-utils, copybook-governance-grid, copybook-options"
        echo "  Level 3 (2): copybook-governance-runtime, copybook-core"
        echo "  Level 4 (3): copybook-governance, copybook-fixed, copybook-rdw"
        echo "  Level 5 (1): copybook-record-io"
        echo "  Level 6 (1): copybook-codec"
        echo "  Level 7 (2): copybook-arrow, copybook-cli"
        echo ""
        echo "Downstream publish dry-runs are run just-in-time in .github/workflows/publish.yml"
        echo "after upstream crates exist on crates.io."
