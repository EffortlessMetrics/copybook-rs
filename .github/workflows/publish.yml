# SPDX-License-Identifier: AGPL-3.0-or-later
name: Publish Crates

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to publish (e.g., v0.3.1)'
        required: true
        type: string

permissions:
  contents: write
  id-token: write

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  release-readiness:
    uses: ./.github/workflows/release-readiness.yml
    with:
      tag: ${{ github.event_name == 'workflow_dispatch' ? github.event.inputs.tag : github.ref_name }}

  release-gate:
    name: Release readiness gate
    runs-on: ubuntu-latest
    needs: [release-readiness]
    steps:
    - name: Confirm readiness gates passed
      run: |
        echo "Release readiness prerequisites passed for ${{ github.event_name == 'workflow_dispatch' ? github.event.inputs.tag : github.ref_name }}."

  publish:
    runs-on: ubuntu-latest
    needs: [release-gate]
    environment: production
    steps:
    - uses: actions/checkout@v6
      with:
        fetch-depth: 0
        ref: ${{ github.event_name == 'workflow_dispatch' ? github.event.inputs.tag : github.ref_name }}

    - uses: dtolnay/rust-toolchain@stable
    - uses: Swatinem/rust-cache@v2
      with:
        key: publish

    - name: Preflight checks
      run: |
        echo "Publishing for tag: ${{ github.event_name == 'workflow_dispatch' ? github.event.inputs.tag : github.ref_name }}"

        # Verify workspace builds cleanly
        cargo build --workspace --release -j 2

        # Run tests to ensure quality
        cargo test --workspace --release -j 2

        # Verify the leaf crate (no workspace deps) packages correctly.
        # Note: `cargo package` / `cargo publish --dry-run` for downstream crates requires their
        # workspace dependencies to exist on crates.io, so we validate them just-in-time below.
        cargo package -p copybook-core

    - name: Publish copybook-core
      env:
        CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
      run: |
        echo "Publishing copybook-core..."
        cargo publish -p copybook-core
        echo "‚úÖ copybook-core published successfully"

    - name: Wait for crates.io index propagation
      env:
        MAX_ATTEMPTS: 10
        RETRY_DELAY_SECONDS: 10
      run: |
        for attempt in $(seq 1 "${MAX_ATTEMPTS}"); do
          if cargo publish -p copybook-codec --dry-run; then
            echo "‚úÖ copybook-core propagation verified."
            break
          fi

          if [ "$attempt" -eq "${MAX_ATTEMPTS}" ]; then
            echo "::error::Timed out waiting for copybook-core to be available on crates.io."
            exit 1
          fi

          echo "copybook-core not yet available; retrying in ${RETRY_DELAY_SECONDS}s... (attempt ${attempt}/${MAX_ATTEMPTS})"
          sleep "${RETRY_DELAY_SECONDS}"
        done

    - name: Dry run publish (copybook-codec)
      run: |
        echo "üì¶ Testing copybook-codec packaging..."
        cargo publish -p copybook-codec --dry-run
        echo "‚úÖ copybook-codec dry-run successful"

    - name: Publish copybook-codec
      env:
        CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
      run: |
        echo "Publishing copybook-codec..."
        cargo publish -p copybook-codec
        echo "‚úÖ copybook-codec published successfully"

    - name: Wait for crates.io index propagation
      env:
        MAX_ATTEMPTS: 10
        RETRY_DELAY_SECONDS: 10
      run: |
        for attempt in $(seq 1 "${MAX_ATTEMPTS}"); do
          if cargo publish -p copybook-cli --dry-run; then
            echo "‚úÖ copybook-codec propagation verified."
            break
          fi

          if [ "$attempt" -eq "${MAX_ATTEMPTS}" ]; then
            echo "::error::Timed out waiting for copybook-codec to be available on crates.io."
            exit 1
          fi

          echo "copybook-codec not yet available; retrying in ${RETRY_DELAY_SECONDS}s... (attempt ${attempt}/${MAX_ATTEMPTS})"
          sleep "${RETRY_DELAY_SECONDS}"
        done

    - name: Dry run publish (copybook-cli)
      run: |
        echo "üì¶ Testing copybook-cli packaging..."
        cargo publish -p copybook-cli --dry-run
        echo "‚úÖ copybook-cli dry-run successful"

    - name: Publish copybook-cli
      env:
        CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
      run: |
        echo "Publishing copybook-cli..."
        cargo publish -p copybook-cli
        echo "‚úÖ copybook-cli published successfully"

    - name: Create GitHub Release
      uses: actions/github-script@v8
      with:
        script: |
          const tag = '${{ github.event_name == 'workflow_dispatch' ? github.event.inputs.tag : github.ref_name }}';
          const version = tag.replace('v', '');

          const { data: release } = await github.rest.repos.createRelease({
            owner: context.repo.owner,
            repo: context.repo.repo,
            tag_name: tag,
            name: `copybook-rs ${version}`,
            body: `## copybook-rs ${version}

          **Installation:**
          \`\`\`bash
          cargo install copybook-cli@${version}
          \`\`\`

          **Crates:**
          - [copybook-core ${version}](https://crates.io/crates/copybook-core/${version})
          - [copybook-codec ${version}](https://crates.io/crates/copybook-codec/${version})
          - [copybook-cli ${version}](https://crates.io/crates/copybook-cli/${version})

          **Documentation:**
          - [copybook-core docs](https://docs.rs/copybook-core/${version})
          - [copybook-codec docs](https://docs.rs/copybook-codec/${version})
          - [copybook-cli docs](https://docs.rs/copybook-cli/${version})

          See [CHANGELOG.md](https://github.com/EffortlessMetrics/copybook-rs/blob/${tag}/CHANGELOG.md) for details.`,
            draft: false,
            prerelease: version.includes('-')
          });

          console.log(\`Created release: \${release.html_url}\`);

  smoke-test:
    runs-on: ubuntu-latest
    needs: publish
    steps:
    - uses: dtolnay/rust-toolchain@stable

    - name: Test installation in clean environment
      run: |
        # Create temporary project to test installation
        cargo new /tmp/copybook-smoke-test
        cd /tmp/copybook-smoke-test

        # Extract version from tag
        VERSION="${{ github.event_name == 'workflow_dispatch' ? github.event.inputs.tag : github.ref_name }}"
        VERSION=${VERSION#v}  # Remove 'v' prefix

        echo "Testing installation of copybook-cli@${VERSION}"

        # Test cargo add works
        cargo add copybook-cli@${VERSION}

        # Test build works
        cargo build --quiet

        echo "‚úÖ Smoke test passed: cargo add copybook-cli@${VERSION} works"

    - name: Validate docs.rs builds
      run: |
        VERSION="${{ github.event_name == 'workflow_dispatch' ? github.event.inputs.tag : github.ref_name }}"
        VERSION=${VERSION#v}

        echo "Checking docs.rs availability..."
        CHECK_ATTEMPTS=20
        RETRY_DELAY_SECONDS=15

        for crate in copybook-core copybook-codec copybook-cli; do
          url="https://docs.rs/${crate}/${VERSION}"
          echo "Checking docs at: ${url}"

          for attempt in $(seq 1 "${CHECK_ATTEMPTS}"); do
            if curl -fsL --max-time 10 -o /dev/null "${url}"; then
              echo "‚úÖ ${url} is available."
              break
            fi

            if [ "$attempt" -eq "${CHECK_ATTEMPTS}" ]; then
              echo "::warning::Timeout waiting for docs at ${url}; continuing with best-effort signal."
              break
            fi

            echo "‚è≥ docs.rs build not complete yet for ${url}; retrying in ${RETRY_DELAY_SECONDS}s... (attempt ${attempt}/${CHECK_ATTEMPTS})"
            sleep "${RETRY_DELAY_SECONDS}"
          done
        done

        echo "‚úÖ Documentation links generated. docs.rs builds asynchronously."

  notify-success:
    runs-on: ubuntu-latest
    needs: [publish, smoke-test]
    if: success()
    steps:
    - name: Success notification
      run: |
        VERSION="${{ github.event_name == 'workflow_dispatch' ? github.event.inputs.tag : github.ref_name }}"
        VERSION=${VERSION#v}

        echo "üöÄ Successfully published copybook-rs ${VERSION}!"
        echo ""
        echo "üì¶ Installation:"
        echo "   cargo install copybook-cli@${VERSION}"
        echo ""
        echo "üìö Documentation:"
        echo "   https://docs.rs/copybook-core/${VERSION}"
        echo "   https://docs.rs/copybook-codec/${VERSION}"
        echo "   https://docs.rs/copybook-cli/${VERSION}"
        echo ""
        echo "üîó Crates.io:"
        echo "   https://crates.io/crates/copybook-core"
        echo "   https://crates.io/crates/copybook-codec"
        echo "   https://crates.io/crates/copybook-cli"
