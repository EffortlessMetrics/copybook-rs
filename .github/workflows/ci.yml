name: CI

on:
  push:
    branches: [ main, develop ]
  # Disabled for PRs - use CI Quick workflow instead
  # pull_request:
  #   branches: [ main, develop ]
  schedule:
    - cron: "23 3 * * *"
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  nightly-soak:
    name: Nightly soak
    if: github.event_name == 'schedule'
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    steps:
    - uses: actions/checkout@v5
    - uses: dtolnay/rust-toolchain@master
      with:
        toolchain: stable
    - uses: Swatinem/rust-cache@v2
    - name: Pre-fetch dependencies
      run: cargo fetch
    - name: Soak tests (ignored, serial)
      env:
        COPYBOOK_TEST_SLOW: "1"
      run: |
        cargo test -p copybook-cli --features soak -- --ignored --test-threads=1 --nocapture

  test:
    name: Test Suite
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        rust:
          - 1.90.0  # MSRV
          - stable
          - beta
        features: ["", "comp3_fast", "audit"]
    steps:
    - uses: actions/checkout@v5
    - uses: dtolnay/rust-toolchain@master
      with:
        toolchain: ${{ matrix.rust }}
    - uses: Swatinem/rust-cache@v2
      with:
        key: ${{ matrix.features }}
    - name: Install nextest
      if: matrix.os == 'ubuntu-latest' && matrix.rust == 'stable' && matrix.features == ''
      uses: taiki-e/install-action@nextest
    - name: Run tests (nextest + junit for test-truth binding)
      if: matrix.os == 'ubuntu-latest' && matrix.rust == 'stable' && matrix.features == ''
      run: |
        cargo nextest run --workspace --profile ci --failure-output=immediate --status-level=fail
        cargo nextest archive --workspace --profile ci --archive-file target/nextest/partial-archive.tar.zst
        cargo nextest report junit --archive-file target/nextest/partial-archive.tar.zst --output-file target/nextest/junit.xml
    - name: Sync test status to docs
      if: matrix.os == 'ubuntu-latest' && matrix.rust == 'stable' && matrix.features == ''
      run: cargo run -p xtask -- docs sync-tests
    - name: Verify test status in docs
      if: matrix.os == 'ubuntu-latest' && matrix.rust == 'stable' && matrix.features == ''
      run: cargo run -p xtask -- docs verify-tests
    - name: Run tests (no features)
      if: matrix.features == '' && !(matrix.os == 'ubuntu-latest' && matrix.rust == 'stable')
      run: cargo test --workspace
    - name: Run tests (with features)
      if: matrix.features != ''
      run: cargo test --workspace --features ${{ matrix.features }}

  rdw-iterator-tests:
    name: RDW iterator tests
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v5
    - uses: dtolnay/rust-toolchain@master
      with:
        toolchain: stable
    - uses: Swatinem/rust-cache@v2
    - name: Zoned parity proptests (ASCII/CP037)
      env:
        PROPTEST_CASES: "512"
        PROPTEST_SEED: "copybook-rs-perf"
      run: cargo test -p copybook-codec --test prop_zoned_parity -- --nocapture
    - name: RDW iterator smoke
      run: cargo test -p copybook-codec --lib -- rdw_
    - name: Phase 4 test summary
      env:
        PROPTEST_CASES: "512"
        PROPTEST_SEED: "copybook-rs-perf"
      run: |
        python3 - <<'PY'
        import os
        from pathlib import Path

        cases = os.getenv("PROPTEST_CASES", "512")
        seed = os.getenv("PROPTEST_SEED", "copybook-rs-perf")
        summary_path = os.getenv("GITHUB_STEP_SUMMARY")
        readme = Path("README.md")
        header = "| Code | Tag  | Meaning (1-liner) | Test |"
        expected_rows = [
            ("2", "CBKD", "Data quality failure", "exit_code_mapping::exit_code_cbkd_is_2"),
            ("3", "CBKE", "Encode/validation failure", "exit_code_mapping::exit_code_cbke_is_3"),
            ("4", "CBKF", "Record format/RDW failure", "exit_code_mapping::exit_code_cbkf_is_4"),
            ("5", "CBKI", "Internal orchestration error", "exit_code_mapping::exit_code_cbki_is_5"),
        ]

        lines = readme.read_text(encoding="utf-8").splitlines()
        table_start = next((idx for idx, line in enumerate(lines) if line.strip() == header), None)
        table_lines = []
        if table_start is None:
            print(f"::warning file={readme},line=1::Exit code table header missing in README.md")
        else:
            idx = table_start
            while idx < len(lines) and lines[idx].strip().startswith("|"):
                table_lines.append(lines[idx])
                idx += 1
            for offset, expected in enumerate(expected_rows, start=1):
                line_no = table_start + offset + 1
                if table_start + offset >= len(lines):
                    print(f"::warning file={readme},line={line_no}::Missing exit code row for {expected[1]}")
                    continue
                cells = [cell.strip() for cell in lines[table_start + offset].strip().strip('|').split('|')]
                if len(cells) != 4:
                    print(f"::warning file={readme},line={line_no}::Unexpected column count ({len(cells)}) in exit code table")
                    continue
                if tuple(cells) != expected:
                    print(f"::warning file={readme},line={line_no}::Expected {expected} but found {tuple(cells)}")
        if not table_lines:
            table_lines = [
                header,
                "|----:|:----:|--------------------|------|",
                *[
                    f"| {code} | {tag} | {meaning} | {test} |"
                    for code, tag, meaning, test in expected_rows
                ],
            ]
        if summary_path:
            with Path(summary_path).open("a", encoding="utf-8") as fh:
                fh.write("### Phase 4 signal\n")
                fh.write(f"- Zoned parity (cases={cases}, seed={seed})\n")
                fh.write("- RDW iterator: green\n")
                fh.write("\n#### Exit Code Matrix\n")
                for line in table_lines:
                    fh.write(f"{line}\n")
                fh.write("\n")
        PY

  exit-code-matrix:
    name: Exit code mapping
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
    steps:
    - uses: actions/checkout@v5
    - uses: dtolnay/rust-toolchain@master
      with:
        toolchain: stable
    - uses: Swatinem/rust-cache@v2
    - name: Run exit code mapping tests
      shell: bash
      run: cargo test -p copybook-cli --test exit_code_mapping -- --nocapture

  fmt:
    name: Rustfmt
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v5
    - uses: dtolnay/rust-toolchain@stable
      with:
        components: rustfmt
    - name: Check formatting
      run: cargo fmt --all -- --check

  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v5
    - uses: dtolnay/rust-toolchain@stable
      with:
        components: clippy
    - uses: Swatinem/rust-cache@v2
    - name: Run clippy
      run: cargo clippy --all-targets --all-features --workspace -- -D warnings -W clippy::pedantic
    - name: Clippy (tests enforce no unwrap/expect)
      run: cargo clippy --workspace --tests --all-features -- -D warnings -D clippy::unwrap_used -D clippy::expect_used
    - name: Enforce panic prevention lints
      run: cargo clippy --all-targets --workspace -- -D warnings -D clippy::unwrap_used -D clippy::expect_used -D clippy::panic -D clippy::unreachable -D clippy::todo -D clippy::unimplemented

  deny:
    name: Cargo Deny
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v5
    - uses: EmbarkStudios/cargo-deny-action@v2
      with:
        log-level: warn
        command: check
        arguments: --all-features

  docs:
    name: Documentation
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v5
    - uses: dtolnay/rust-toolchain@stable
    - uses: Swatinem/rust-cache@v2
    - name: Check documentation
      run: cargo doc --all-features --workspace --no-deps
      env:
        RUSTDOCFLAGS: -D warnings

  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v5
    - uses: dtolnay/rust-toolchain@stable
      with:
        components: llvm-tools-preview
    - uses: Swatinem/rust-cache@v2
    - name: Install cargo-llvm-cov
      uses: taiki-e/install-action@cargo-llvm-cov
    - name: Generate code coverage
      run: cargo llvm-cov --workspace --exclude copybook-bench --lcov --output-path lcov.info
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v5
      with:
        files: lcov.info
        fail_ci_if_error: true

  strict-comments:
    name: Strict Comments Mode
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v5
    - uses: dtolnay/rust-toolchain@stable
    - uses: Swatinem/rust-cache@v2
    - name: Run core tests with strict comments mode
      run: cargo test --package copybook-core
      env:
        COPYBOOK_TEST_STRICT_COMMENTS: "1"

  result-docs-advisory:
    name: Result Docs Advisory
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
    - uses: actions/checkout@v5
    - name: Check public Result docs
      run: bash scripts/check-public-result-docs.sh

  security-audit:
    name: Security Audit (cargo-audit)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
    - uses: actions/checkout@v5

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable

    - name: Cache cargo dependencies
      uses: Swatinem/rust-cache@v2
      with:
        shared-key: advisory-db  # Share advisory database cache across jobs

    - name: Install cargo-audit
      run: cargo install cargo-audit --locked || true

    - name: Run cargo audit
      id: audit
      run: |
        cargo audit -q --json > target/security.audit.json || true

    - name: Validate audit results
      run: |
        python3 - <<'PY'
        import json, sys, pathlib
        p = pathlib.Path("target/security.audit.json")
        if not p.exists():
            print("WARN: no cargo-audit output")
            sys.exit(0)
        j = json.load(p.open())
        v = len(j.get("vulnerabilities",{}).get("list",[]))
        print(f"cargo-audit: {v} vulnerabilities")
        sys.exit(1 if v>0 else 0)
        PY

    - name: Upload security receipts
      if: always()
      uses: actions/upload-artifact@v5
      with:
        name: security-receipts-${{ github.sha }}
        path: target/security.audit.json
        retention-days: 90
