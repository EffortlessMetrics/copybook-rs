name: Fuzz Testing

on:
  workflow_dispatch:
    inputs:
      proptest_cases:
        description: 'Number of proptest cases per target'
        required: false
        default: '10000'
        type: string

concurrency:
  group: ci-fuzz-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  PROPTEST_CASES: ${{ inputs.proptest_cases || '10000' }}
  PROPTEST_MAX_SHRINK_ITERS: "1000"

jobs:
  proptest-fuzz:
    name: Extended Proptest Fuzzing
    runs-on: ubuntu-latest
    timeout-minutes: 60

    strategy:
      fail-fast: false
      matrix:
        target:
          - name: zoned-decimal
            package: copybook-codec
            test_filter: "prop_"
          - name: comp3-roundtrip
            package: copybook-codec
            test_filter: "comp3_"
          - name: json-fuzzing
            package: copybook-bench
            test_file: json_fuzzing_tests

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: "1.92.0"

      - name: Cache cargo build
        uses: Swatinem/rust-cache@v2
        with:
          key: fuzz-proptest-${{ matrix.target.name }}
          save-if: ${{ github.ref == 'refs/heads/main' }}

      - name: Run extended proptest (${{ matrix.target.name }})
        id: proptest
        timeout-minutes: 15
        run: |
          START_TIME=$(date +%s)

          if [ -n "${{ matrix.target.test_file }}" ]; then
            TEST_CMD="cargo test -p ${{ matrix.target.package }} --test ${{ matrix.target.test_file }} --all-features -- --nocapture"
          else
            TEST_CMD="cargo test -p ${{ matrix.target.package }} --all-features -- ${{ matrix.target.test_filter }} --nocapture"
          fi

          echo "Running: $TEST_CMD"

          set +e
          $TEST_CMD 2>&1 | tee /tmp/proptest-output.log
          EXIT_CODE=${PIPESTATUS[0]}
          set -e

          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))

          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          echo "duration=$DURATION" >> $GITHUB_OUTPUT

          exit $EXIT_CODE

      - name: Capture regressions
        if: failure()
        run: |
          mkdir -p artifacts/proptest-regressions
          find . -name "*.proptest-regressions" -exec cp {} artifacts/proptest-regressions/ \; 2>/dev/null || true

      - name: Upload regression artifacts
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: proptest-regressions-${{ matrix.target.name }}-${{ github.sha }}
          path: artifacts/proptest-regressions/
          retention-days: 90
          if-no-files-found: ignore

  fuzz-summary:
    name: Fuzz Summary
    runs-on: ubuntu-latest
    needs: [proptest-fuzz]
    if: always()

    steps:
      - name: Aggregate results
        run: |
          echo "## Weekly Fuzz Testing Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date**: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Extended Proptest Coverage" >> $GITHUB_STEP_SUMMARY
          echo "- Targets: zoned-decimal, comp3-roundtrip, json-fuzzing" >> $GITHUB_STEP_SUMMARY
          echo "- Cases per target: ${PROPTEST_CASES:-10000}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          PROPTEST_STATUS="${{ needs.proptest-fuzz.result }}"
          if [ "$PROPTEST_STATUS" = "success" ]; then
            echo "**Status**: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Status**: FAILED - Review artifacts" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fail if tests failed
        if: needs.proptest-fuzz.result == 'failure'
        run: exit 1
