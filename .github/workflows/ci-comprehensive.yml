name: CI Comprehensive

on:
  workflow_dispatch:
  schedule:
    # Run nightly at 4 AM UTC
    - cron: '0 4 * * *'
  pull_request:
    # Manual opt-in via label
    types: [labeled]

jobs:
  comprehensive:
    name: Comprehensive Tests
    runs-on: ubuntu-latest
    # Skip if not labeled with 'comprehensive' (for PR triggers)
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'schedule' ||
      contains(github.event.pull_request.labels.*.name, 'comprehensive')

    steps:
      - uses: actions/checkout@v5

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2

      - name: Run comprehensive REDEFINES/ODO tests
        run: |
          cargo nextest run \
            -p copybook-codec \
            --test comprehensive_redefines_odo_tests \
            --features comprehensive-tests \
            --no-fail-fast
        continue-on-error: true
        id: comprehensive_tests

      - name: Report test status
        if: always()
        run: |
          if [ "${{ steps.comprehensive_tests.outcome }}" = "failure" ]; then
            echo "::warning::Comprehensive tests failed - this is expected and non-blocking"
            echo "::notice::See https://github.com/${{ github.repository }}/issues for tracking"
          else
            echo "::notice::Comprehensive tests passed!"
          fi

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: comprehensive-test-results
          path: |
            target/nextest/**/*.xml
            target/nextest/**/*.log
          retention-days: 7
