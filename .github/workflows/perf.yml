name: Perf Receipts
on:
  # Run on demand, nightly, release tags, and opt-in PRs
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *'   # nightly at 03:00 UTC
  push:
    tags:
      - 'v*'   # run on version tags (e.g., v0.3.1, v1.0.0)
  # Opt-in for PRs via 'run-perf' label
  pull_request:
    types: [labeled]
    paths:
      - "copybook-bench/**"
      - "copybook-codec/**"
      - "scripts/bench.sh"
      - "scripts/bench.bat"
      - "scripts/guard-hotpaths.sh"
      - "justfile"

concurrency:
  group: perf-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  perf:
    # Only run on PRs when 'run-perf' label is present; always run on push/schedule/dispatch
    if: |
      github.event_name != 'pull_request' ||
      contains(github.event.pull_request.labels.*.name, 'run-perf')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2
        with:
          save-if: ${{ github.ref == 'refs/heads/main' }}

      - name: Install cargo-nextest
        uses: taiki-e/install-action@v2
        with:
          tool: nextest

      - name: Hot-path guard
        run: bash scripts/guard-hotpaths.sh

      - name: Hygiene and build
        run: |
          cargo fmt --all --check
          cargo clippy --workspace --all-targets --all-features -- -D warnings -W clippy::pedantic
          cargo build --workspace --release
          cargo nextest run --workspace

      - name: Property tests (fast deterministic)
        env:
          PROPTEST_CASES: "256"
          PROPTEST_SEED: ${{ env.PROPTEST_SEED || 'copybook-rs-perf' }}
        run: |
          cargo test -p copybook-codec \
            prop_zoned_digit_buffer_contains_only_digits \
            zoned_overpunch \
            -- --nocapture

      - name: Run benches (JSON)
        run: bash scripts/bench.sh

      - name: Annotate perf with host info
        run: bash scripts/perf-annotate-host.sh
      - name: Perf headline (summary)
        run: |
          jq -r '
            (.summary // {}) as $s
            | ([
                $s.host_cpu,
                (if $s.host_cores != null then ($s.host_cores|tostring + "c") else empty end),
                (if ($s.host_os // "") != "" or ($s.host_kernel // "") != "" then [($s.host_os // ""), ($s.host_kernel // "")] | join("/") else empty end)
              ] | map(select(. != "")) | join(" • ")) as $host
            | "DISPLAY: \($s.display_mibps // "n/a") MiB/s\nCOMP-3: \($s.comp3_mibps // "n/a") MiB/s\nMax RSS: \($s.max_rss_mib // "n/a") MiB\nHost: \($host // "n/a")\nP50/P90/P99: \($s.p50_mibps // "n/a")/\($s.p90_mibps // "n/a")/\($s.p99_mibps // "n/a") MiB/s"
          ' scripts/bench/perf.json >> "$GITHUB_STEP_SUMMARY"

      - name: Stamp telemetry checklist with commit hash
        run: |
          SHA=$(git rev-parse --short HEAD)
          sed -i "s/<GIT_SHORT_SHA>/${SHA}/g" docs/telemetry-launch-checklist.md

      - name: Upload stamped telemetry checklist (optional)
        uses: actions/upload-artifact@v6
        with:
          name: telemetry-launch-checklist
          path: docs/telemetry-launch-checklist.md
          retention-days: 30

      - name: Upload perf receipts (90 days)
        uses: actions/upload-artifact@v6
        with:
          name: perf-json
          path: scripts/bench/perf.json
          retention-days: 90

      - name: Summarize SLOs (robust jq)
        id: slo
        shell: bash
        run: |
          f=scripts/bench/perf.json
          disp=$(jq -r '
            [
              .display_mibps?,
              .metrics?.display_mibps?,
              (.benchmarks[]? | .display_mibps?),
              (.benchmarks[]? | .throughput_mib? | select(. != null))
            ] | map(select(. != null)) | (max // 0)
          ' "$f")

          comp=$(jq -r '
            [
              .comp3_mibps?,
              .metrics?.comp3_mibps?,
              (.benchmarks[]? | .comp3_mibps?),
              (.benchmarks[]? | .comp3_throughput_mib?),
              (.benchmarks[]? | .throughput_mib? | select(. != null and . < 200))
            ] | map(select(. != null)) | (max // 0)
          ' "$f")

          rss=$(jq -r '.summary.max_rss_mib // 0' "$f")

          echo "display=$disp" >> "$GITHUB_OUTPUT"
          echo "comp3=$comp"   >> "$GITHUB_OUTPUT"
          echo "rss=$rss"      >> "$GITHUB_OUTPUT"
          DISP="$disp" COMP="$comp" RSS="$rss" python - <<'PY' >> "$GITHUB_OUTPUT"
          import os
          disp = float(os.environ.get("DISP", "0"))
          comp = float(os.environ.get("COMP", "0"))
          rss = float(os.environ.get("RSS", "0"))
          ok = disp >= 80 and comp >= 40 and rss <= 256
          print(f"ok={'true' if ok else 'false'}")
          PY

      - name: Publish Throughput badge (neutral on fail)
        id: throughput
        uses: actions/github-script@v8
        env:
          DISPLAY_MIB: ${{ steps.slo.outputs.display }}
          COMP3_MIB: ${{ steps.slo.outputs.comp3 }}
          MAX_RSS: ${{ steps.slo.outputs.rss }}
        with:
          script: |
            const fs = require('fs');
            const core = require('@actions/core');
            const path = 'scripts/bench/perf.json';
            const summary = (() => {
              try {
                const data = JSON.parse(fs.readFileSync(path, 'utf8'));
                return data.summary || {};
              } catch (error) {
                core.warning(`Failed to read ${path}: ${error}`);
                return {};
              }
            })();
            const display = Number(process.env.DISPLAY_MIB || 0);
            const comp = Number(process.env.COMP3_MIB || 0);
            const rss = Number(process.env.MAX_RSS || (summary.max_rss_mib ?? 0));
            const host = [
              summary.host_cpu,
              summary.host_cores != null ? `${summary.host_cores}c` : null,
              summary.host_os && summary.host_kernel ? `${summary.host_os}/${summary.host_kernel}` :
                (summary.host_os || summary.host_kernel || null)
            ].filter(Boolean).join(' • ');
            const ok = display >= 80 && comp >= 40 && rss <= 256;
            await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'review:gate:throughput',
              head_sha: context.sha,
              status: 'completed',
              conclusion: ok ? 'success' : 'neutral',
              output: {
                title: 'Throughput SLOs',
                summary:
                  `DISPLAY: ${display} MiB/s (>=80)\n` +
                  `COMP-3:  ${comp} MiB/s (>=40)\n` +
                  `Max RSS: ${rss} MiB (<=256)\n` +
                  (host ? `Host: ${host}\n` : '')
              }
            });
            core.setOutput('ok', ok ? 'true' : 'false');

      - name: Label perf success
        if: ${{ success() && steps.throughput.outputs.ok == 'true' && github.event.pull_request.number }}
        uses: actions/github-script@v8
        with:
          script: |
            const core = require('@actions/core');
            const label = 'ready:perf-ok';
            try {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                labels: [label],
              });
            } catch (error) {
              core.warning(`Unable to add ${label}: ${error.message}`);
            }

      - name: Job summary
        if: ${{ always() }}
        env:
          PERF_OK: ${{ steps.throughput.outputs.ok }}
        run: |
          echo "### Throughput SLOs" >> "$GITHUB_STEP_SUMMARY"
          if [[ -f scripts/bench/perf.json ]]; then
            echo "- DISPLAY: ${{ steps.slo.outputs.display }} MiB/s (>= 80)" >> "$GITHUB_STEP_SUMMARY"
            echo "- COMP-3:  ${{ steps.slo.outputs.comp3 }} MiB/s (>= 40)" >> "$GITHUB_STEP_SUMMARY"
            echo "- Max RSS: $(jq -r '.summary.max_rss_mib // "n/a"' scripts/bench/perf.json) MiB (<= 256)" >> "$GITHUB_STEP_SUMMARY"
            echo "- Host: $(jq -r '.summary | [
                .host_cpu,
                (if .host_cores != null then (.host_cores|tostring + "c") else empty end),
                (if .host_os or .host_kernel then [( .host_os // ""), ( .host_kernel // "" )] | join("/") else empty end)
              ] | map(select(. != "")) | join(" • ") // "n/a"' scripts/bench/perf.json)" >> "$GITHUB_STEP_SUMMARY"
            status="neutral"
            if [[ "${PERF_OK}" == "true" ]]; then
              status="success"
            fi
            echo "- Check-run conclusion: ${status}" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "- Receipts missing; see logs for details." >> "$GITHUB_STEP_SUMMARY"
          fi
