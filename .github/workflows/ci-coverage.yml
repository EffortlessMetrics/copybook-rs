# SPDX-License-Identifier: AGPL-3.0-or-later
name: Code Coverage

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ github.event_name }}
  cancel-in-progress: true

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  COVERAGE_MINIMUM: "80.0"
  COVERAGE_FLOOR: 80

jobs:
  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Setup Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable

    - name: Cache cargo artifacts
      uses: Swatinem/rust-cache@v2
      with:
        cache-targets: true

    - name: Install cargo-tarpaulin
      run: cargo install cargo-tarpaulin --version 0.31.5

    - name: Run tarpaulin coverage
      run: |
        cargo tarpaulin \
          --workspace \
          --exclude copybook-bench \
          --exclude-files 'examples/*' \
          --exclude-files 'tests/*' \
          --exclude-files 'xtask/*' \
          --exclude-files 'copybook-cli/tests/*' \
          --exclude-files 'copybook-core/tests/*' \
          --exclude-files 'copybook-codec/tests/*' \
          --out Xml \
          --output-dir ./coverage \
          --verbose \
          --timeout 300 \
          --all-features \
          --test-threads 4

    - name: Enforce minimum coverage floor
      id: enforce-coverage
      run: |
        set -euo pipefail

        COVERAGE_PERCENT=$(python3 - <<'PY'
import os
import sys
import xml.etree.ElementTree as ET

coverage_file = "coverage/cobertura.xml"
minimum = float(os.environ["COVERAGE_MINIMUM"])

if not os.path.exists(coverage_file):
    print(f"ERROR: {coverage_file} does not exist", file=sys.stderr)
    sys.exit(1)

root = ET.parse(coverage_file).getroot()
line_rate = root.attrib.get("line-rate")
if line_rate is None:
    package = root.find(".//package")
    if package is None or package.attrib.get("line-rate") is None:
        print("ERROR: coverage report missing line-rate", file=sys.stderr)
        sys.exit(1)
    line_rate = package.attrib.get("line-rate")

coverage = round(float(line_rate) * 100, 2)
print(f"{coverage}")
if coverage < minimum:
    print(f"::error::Coverage floor failed: {coverage}% < {minimum}%", file=sys.stderr)
    sys.exit(1)

print(f"Coverage floor passed: {coverage}% >= {minimum}%", file=sys.stderr)
PY
        )
        echo "coverage_percent=$COVERAGE_PERCENT" >> "$GITHUB_OUTPUT"

    - name: Generate coverage summary
      run: |
        if [ -f coverage/cobertura.xml ]; then
          echo "Coverage report generated successfully"
          echo "Coverage file size: $(wc -c < coverage/cobertura.xml) bytes"
        else
          echo "ERROR: Coverage report not found"
          exit 1
        fi

    - name: Enforce coverage floor
      run: |
        python3 - <<'PY'
        import os
        import pathlib
        import sys
        import xml.etree.ElementTree as ET

        report = pathlib.Path("coverage/cobertura.xml")
        if not report.exists():
            print("ERROR: coverage report missing at coverage/cobertura.xml")
            sys.exit(1)

        floor = float(os.environ["COVERAGE_FLOOR"])
        tree = ET.parse(report)
        root = tree.getroot()
        line_rate = float(root.attrib.get("line-rate", "0"))
        coverage = line_rate * 100

        print(f"Coverage line-rate: {coverage:.2f}%")
        print(f"Coverage floor:   {floor:.2f}%")

        if coverage < floor:
            print(f"FAIL: Coverage floor not met ({coverage:.2f}% < {floor:.2f}%)")
            sys.exit(1)

        print("PASS: Coverage floor met")
        PY

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v5
      with:
        file: ./coverage/cobertura.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false
        token: ${{ secrets.CODECOV_TOKEN }}

    - name: Upload coverage artifacts
      uses: actions/upload-artifact@v6
      with:
        name: coverage-report
        path: coverage/
        retention-days: 30

    - name: Add coverage summary
      run: |
        echo "# Code Coverage Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Coverage has been generated and uploaded to Codecov." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Coverage Details" >> $GITHUB_STEP_SUMMARY
        echo "- **Tool**: cargo-tarpaulin 0.31.5" >> $GITHUB_STEP_SUMMARY
        echo "- **Features**: All features enabled" >> $GITHUB_STEP_SUMMARY
        echo "- **Line coverage**: ${{ steps.enforce-coverage.outputs.coverage_percent }}% (minimum: ${COVERAGE_MINIMUM}%)" >> $GITHUB_STEP_SUMMARY
        echo "- **Excluded**: copybook-bench, examples, integration tests" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "View detailed coverage report on [Codecov](https://codecov.io/gh/${{ github.repository }})." >> $GITHUB_STEP_SUMMARY

  coverage-diff:
    name: Coverage Diff
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    needs: coverage

    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - name: Setup Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable

    - name: Cache cargo artifacts
      uses: Swatinem/rust-cache@v2
      with:
        cache-targets: true

    - name: Install cargo-tarpaulin
      run: cargo install cargo-tarpaulin --version 0.31.5

    - name: Run coverage diff
      run: |
        # Get base branch coverage
        git fetch origin ${{ github.base_ref }}
        git checkout origin/${{ github.base_ref }}
        cargo tarpaulin \
          --workspace \
          --exclude copybook-bench \
          --exclude-files 'examples/*' \
          --exclude-files 'tests/*' \
          --out Xml \
          --output-dir ./coverage-base \
          --timeout 300 \
          --all-features

        # Get PR branch coverage
        git checkout ${{ github.sha }}
        cargo tarpaulin \
          --workspace \
          --exclude copybook-bench \
          --exclude-files 'examples/*' \
          --exclude-files 'tests/*' \
          --out Xml \
          --output-dir ./coverage-pr \
          --timeout 300 \
          --all-features

        echo "Coverage diff analysis complete"
        echo "Base branch: ${{ github.base_ref }}"
        echo "PR branch: ${{ github.head_ref }}"

    - name: Comment coverage on PR
      uses: actions/github-script@v8
      with:
        script: |
          const fs = require('fs');
          let comment = '## Coverage Report\n\n';
          comment += 'Coverage analysis has been run for this PR.\n\n';
          comment += 'Please check the Coverage job for detailed results.\n\n';
          comment += 'Coverage reports are available as artifacts.';
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

  coverage-gate:
    name: Coverage Gate
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'pull_request' && github.base_ref == 'main') ||
      (github.event_name == 'push' && github.ref == 'refs/heads/main')
    needs:
      - coverage
      - coverage-diff
    steps:
      - name: Aggregate required coverage prereqs
        if: always()
        run: |
          set -euo pipefail

          echo "## Coverage Gate" >> "$GITHUB_STEP_SUMMARY"
          echo "| Check | Result |" >> "$GITHUB_STEP_SUMMARY"
          echo "|------|--------|" >> "$GITHUB_STEP_SUMMARY"

          failed=0
          echo "| coverage | ${{ needs.coverage.result }} |" >> "$GITHUB_STEP_SUMMARY"
          if [ "${{ needs.coverage.result }}" != "success" ]; then
            echo "::error::Coverage job failed with status '${{ needs.coverage.result }}'."
            failed=1
          fi

          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "| coverage-diff | ${{ needs['coverage-diff'].result }} |" >> "$GITHUB_STEP_SUMMARY"
            if [ "${{ needs['coverage-diff'].result }}" != "success" ]; then
              echo "::error::Coverage diff job failed with status '${{ needs['coverage-diff'].result }}'."
              failed=1
            fi
          else
            echo "| coverage-diff | skipped |" >> "$GITHUB_STEP_SUMMARY"
          fi

          if [ "$failed" -ne 0 ]; then
            echo "::error::Coverage Gate failed."
            exit 1
          fi

          echo "| coverage-percent | ${{ needs.coverage.outputs.coverage_percent }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "âœ… Coverage Gate passed for commit ${GITHUB_SHA}."
