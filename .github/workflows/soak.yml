name: Soak

on:
  workflow_dispatch:
    inputs:
      minutes:
        description: "Bench minutes (approx)"
        default: "20"
  schedule:
    - cron: "0 5 * * 6"

concurrency:
  group: soak-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read
  checks: write

jobs:
  soak:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: cp037-rdw-display
            codepage: cp037
            format: rdw
            workload: display-heavy
            size: 1GiB
            zoned_policy: preferred
          - name: cp273-rdw-comp3
            codepage: cp273
            format: rdw
            workload: comp3-heavy
            size: 100MiB
            zoned_policy: override-ebcdic
          - name: cp500-rdw-mixed
            codepage: cp500
            format: rdw
            workload: mixed
            size: 5GiB
            zoned_policy: preserved
          - name: cp1047-fixed-display
            codepage: cp1047
            format: fixed
            workload: display-heavy
            size: 1GiB
            zoned_policy: override-ascii
          - name: cp1140-fixed-comp3
            codepage: cp1140
            format: fixed
            workload: comp3-heavy
            size: 100MiB
            zoned_policy: preferred
          - name: ascii-fixed-mixed
            codepage: ascii
            format: fixed
            workload: mixed
            size: 100MiB
            zoned_policy: override-ascii

    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2

      - name: Generate synthetic dataset
        env:
          WORKLOAD: ${{ matrix.workload }}
          ZONED_POLICY: ${{ matrix.zoned_policy }}
          SOAK_SEED: soak-${{ matrix.name }}
        run: |
          mkdir -p ./target/soak
          ./scripts/gen_dataset.sh "${{ matrix.format }}" "${{ matrix.codepage }}" "${{ matrix.size }}" "./target/soak/${{ matrix.name }}.bin"

      - name: Benches (wide run)
        env:
          BENCH_FILTER: all
          CODEPAGE: ${{ matrix.codepage }}
          FORMAT: ${{ matrix.format }}
          WORKLOAD: ${{ matrix.workload }}
        run: bash scripts/bench.sh

      - name: Aggregate percentiles
        run: bash scripts/soak-aggregate.sh

      - name: Upload soak receipts
        uses: actions/upload-artifact@v4
        with:
          name: soak-${{ matrix.name }}
          path: scripts/bench/perf.json
          retention-days: 90

      - name: Publish soak check-run
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const perf = JSON.parse(fs.readFileSync('scripts/bench/perf.json','utf8'));
            const summary = perf.summary || {};
            await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: `soak:${{ matrix.format }}:${{ matrix.codepage }}`,
              head_sha: context.sha,
              status: "completed",
              conclusion: "success",
              output: {
                title: "Soak SLOs",
                summary:
                  `DISPLAY: ${summary.display_mibps ?? 'n/a'} MiB/s\n` +
                  `COMP-3:  ${summary.comp3_mibps ?? 'n/a'} MiB/s\n` +
                  `Max RSS: ${summary.max_rss_mib ?? 'n/a'} MiB\n` +
                  `p50: ${summary.p50_mibps ?? 'n/a'} • p90: ${summary.p90_mibps ?? 'n/a'} • p99: ${summary.p99_mibps ?? 'n/a'}`
              }
            });
