{
  "schemaVersion": 39,
  "title": "Copybook Telemetry",
  "timezone": "browser",
  "refresh": "30s",
  "panels": [
    {
      "type": "text",
      "title": "Operator quick links",
      "gridPos": {
        "x": 0,
        "y": 0,
        "w": 24,
        "h": 4
      },
      "options": {
        "mode": "markdown",
        "content": "# Copybook Telemetry - Operator Links\n\n### Runbooks\n- **Launch checklist** -> [`docs/telemetry-launch-checklist.md`](https://github.com/effortlessmetrics/copybook-rs/blob/main/docs/telemetry-launch-checklist.md)\n- **Rollout guide** -> [`docs/TELEMETRY_ROLLOUT.md`](https://github.com/effortlessmetrics/copybook-rs/blob/main/docs/TELEMETRY_ROLLOUT.md)\n- **Roadmap** -> [`docs/ROADMAP.md`](https://github.com/effortlessmetrics/copybook-rs/blob/main/docs/ROADMAP.md)\n\n---\n\n### CI Artifacts & Receipts\n- **Perf receipts (perf.json)** -> Actions > [Perf Receipts](https://github.com/effortlessmetrics/copybook-rs/actions/workflows/perf.yml) (check the latest run; artifact: `perf-json`)\n- **Stamped launch checklist** -> Actions > [Perf Receipts](https://github.com/effortlessmetrics/copybook-rs/actions/workflows/perf.yml) (artifact: `telemetry-launch-checklist-...`)\n- **Soak matrix artifacts** -> Actions > [Soak](https://github.com/effortlessmetrics/copybook-rs/actions/workflows/soak.yml) (per-matrix `perf.json` with `p50/p90/p99`)\n\n> **Badge**: PRs show a **Throughput** check with host (CPU/OS). Gate is neutral on slow runners.\n\n---\n\n### Quick Commands (local)\n```bash\n# Perf receipts (fast SLO suite) + host annotation\nBENCH_FILTER=slo_validation bash scripts/bench.sh\nbash scripts/perf-annotate-host.sh\njq '.summary' scripts/bench/perf.json\n\n# Shadow diff (JSONL aside)\nbash scripts/shadow-diff.sh /path/current.jsonl /path/copybook.jsonl\n\n# Soak dispatch (CI)\nbash scripts/soak-dispatch.sh\n```\n\n---\n\n### Alerts (what they mean)\n\n* **CopybookErrorBurst** - `sum(rate(copybook_decode_errors_total[5m])) by (family) > 0` for 10m\n  *Action:* inspect `/metrics`, confirm **family** (CBKD/CBKE/**CBKF**/CBKI), check logs for first error.\n* **CopybookThroughputDrop** - `avg_over_time(copybook_throughput_mibps[15m]) by (format,codepage) < FLOOR` for 15m\n  *Action:* check underlying IO/CPU pressure; validate floor for this runner.\n\n---\n\n### RDW iterator semantics (CBKF102)\n\n- **EOF / short header** \u2192 no error (treated as stream end)\n- **Malformed/undersized body** \u2192 `CBKF102_RECORD_LENGTH_INVALID` (family **CBKF**)\n- Reader borrows record body via `fill_buf()`; consumes exactly `len` **after** the borrow ends (next poll). No copies on the hot path.\n\n---\n\n### Notes\n\n* Telemetry is **feature-gated**; exporter binds only when CLI runs with `--metrics-listen <addr>`.\n* Short error runs may require `--metrics-grace-ms 2000` to keep `/metrics` scrapeable for a few seconds.\n* Labels are low-cardinality: `format`, `codepage`, `zero_policy` (and `family` on the error counter).\n\n*Last verified against commit: **<GIT_SHORT_SHA>***"
      }
    },
    {
      "type": "timeseries",
      "title": "QPS (records/s)",
      "datasource": {
        "type": "prometheus",
        "uid": "$DS_PROMETHEUS"
      },
      "targets": [
        {
          "expr": "sum(rate(copybook_records_total[5m])) by (format, codepage)",
          "legendFormat": "{{format}} • {{codepage}}"
        }
      ],
      "gridPos": {
        "x": 0,
        "y": 4,
        "w": 12,
        "h": 8
      }
    },
    {
      "type": "timeseries",
      "title": "Bytes/s",
      "datasource": {
        "type": "prometheus",
        "uid": "$DS_PROMETHEUS"
      },
      "targets": [
        {
          "expr": "sum(rate(copybook_bytes_total[5m])) by (format, codepage)",
          "legendFormat": "{{format}} • {{codepage}}"
        }
      ],
      "gridPos": {
        "x": 12,
        "y": 4,
        "w": 12,
        "h": 8
      }
    },
    {
      "type": "timeseries",
      "title": "Error rate (by family)",
      "datasource": {
        "type": "prometheus",
        "uid": "$DS_PROMETHEUS"
      },
      "targets": [
        {
          "expr": "sum(rate(copybook_decode_errors_total[5m])) by (family)",
          "legendFormat": "{{family}}"
        }
      ],
      "gridPos": {
        "x": 0,
        "y": 12,
        "w": 12,
        "h": 8
      }
    },
    {
      "type": "timeseries",
      "title": "MiB/s",
      "datasource": {
        "type": "prometheus",
        "uid": "$DS_PROMETHEUS"
      },
      "targets": [
        {
          "expr": "avg(copybook_throughput_mibps) by (format, codepage)",
          "legendFormat": "{{format}} • {{codepage}}"
        }
      ],
      "gridPos": {
        "x": 12,
        "y": 12,
        "w": 12,
        "h": 8
      }
    }
  ],
  "version": 2
}
