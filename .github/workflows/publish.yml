# SPDX-License-Identifier: AGPL-3.0-or-later
name: Publish Crates

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to publish (e.g., v0.3.1)'
        required: true
        type: string

permissions:
  contents: write
  id-token: write

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  publish:
    runs-on: ubuntu-latest
    environment: production
    steps:
    - uses: actions/checkout@v6
      with:
        fetch-depth: 0
        ref: ${{ github.event.inputs.tag || github.ref }}

    - uses: dtolnay/rust-toolchain@stable
    - uses: Swatinem/rust-cache@v2
      with:
        key: publish

    - name: Preflight checks
      run: |
        echo "Publishing for tag: ${{ github.ref_name || github.event.inputs.tag }}"

        # Verify workspace builds cleanly
        cargo build --workspace --release -j 2

        # Run tests to ensure quality
        cargo test --workspace --release -j 2

        # Verify the leaf crate (no workspace deps) packages correctly.
        cargo package -p copybook-error

    - name: Publish all crates in dependency order
      env:
        CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
      run: |
        set -euo pipefail

        publish_crate() {
          local crate="$1"
          echo "Publishing ${crate}..."
          cargo publish -p "${crate}" || {
            # Tolerate "already exists" (re-run after partial failure)
            if cargo publish -p "${crate}" 2>&1 | grep -q "already exists"; then
              echo "  ${crate} already published, skipping"
            else
              echo "  FAILED to publish ${crate}"
              return 1
            fi
          }
          echo "  ${crate} published successfully"
        }

        wait_for_index() {
          local seconds="${1:-60}"
          echo "Waiting ${seconds}s for crates.io index propagation..."
          sleep "${seconds}"
        }

        # Level 0: No internal dependencies (7 crates)
        echo "=== Level 0: Foundation crates ==="
        publish_crate copybook-error
        publish_crate copybook-determinism
        publish_crate copybook-dialect
        publish_crate copybook-codepage
        publish_crate copybook-contracts
        publish_crate copybook-support-matrix
        publish_crate copybook-sequence-ring
        wait_for_index 60

        # Level 1: Depends only on Level 0 (6 crates)
        echo "=== Level 1: Core primitives ==="
        publish_crate copybook-overflow
        publish_crate copybook-error-reporter
        publish_crate copybook-charset
        publish_crate copybook-governance-contracts
        publish_crate copybook-codec-memory
        publish_crate copybook-overpunch
        wait_for_index 60

        # Level 2: Depends on Level 0-1 (3 crates)
        echo "=== Level 2: Utilities ==="
        publish_crate copybook-utils
        publish_crate copybook-governance-grid
        publish_crate copybook-options
        wait_for_index 60

        # Level 3: Depends on Level 0-2 (2 crates)
        echo "=== Level 3: Core + governance runtime ==="
        publish_crate copybook-governance-runtime
        publish_crate copybook-core
        wait_for_index 60

        # Level 4: Depends on Level 0-3 (3 crates)
        echo "=== Level 4: Record formats + governance ==="
        publish_crate copybook-governance
        publish_crate copybook-fixed
        publish_crate copybook-rdw
        wait_for_index 60

        # Level 5: Depends on Level 0-4 (1 crate)
        echo "=== Level 5: Record I/O ==="
        publish_crate copybook-record-io
        wait_for_index 60

        # Level 6: Depends on Level 0-5 (1 crate)
        echo "=== Level 6: Codec ==="
        publish_crate copybook-codec
        wait_for_index 60

        # Level 7: Depends on Level 0-6 (2 crates)
        echo "=== Level 7: Arrow + CLI ==="
        publish_crate copybook-arrow
        publish_crate copybook-cli

        echo ""
        echo "All 25 crates published successfully!"

    - name: Create GitHub Release
      uses: actions/github-script@v8
      with:
        script: |
          const tag = '${{ github.ref_name || github.event.inputs.tag }}';
          const version = tag.replace('v', '');

          const { data: release } = await github.rest.repos.createRelease({
            owner: context.repo.owner,
            repo: context.repo.repo,
            tag_name: tag,
            name: `copybook-rs ${version}`,
            body: `## copybook-rs ${version}

          **Installation:**
          \`\`\`bash
          cargo install copybook-cli@${version}
          \`\`\`

          **Published Crates (25):**

          | Crate | crates.io | docs.rs |
          |-------|-----------|---------|
          | copybook-error | [${version}](https://crates.io/crates/copybook-error/${version}) | [docs](https://docs.rs/copybook-error/${version}) |
          | copybook-determinism | [${version}](https://crates.io/crates/copybook-determinism/${version}) | [docs](https://docs.rs/copybook-determinism/${version}) |
          | copybook-dialect | [${version}](https://crates.io/crates/copybook-dialect/${version}) | [docs](https://docs.rs/copybook-dialect/${version}) |
          | copybook-codepage | [${version}](https://crates.io/crates/copybook-codepage/${version}) | [docs](https://docs.rs/copybook-codepage/${version}) |
          | copybook-contracts | [${version}](https://crates.io/crates/copybook-contracts/${version}) | [docs](https://docs.rs/copybook-contracts/${version}) |
          | copybook-support-matrix | [${version}](https://crates.io/crates/copybook-support-matrix/${version}) | [docs](https://docs.rs/copybook-support-matrix/${version}) |
          | copybook-sequence-ring | [${version}](https://crates.io/crates/copybook-sequence-ring/${version}) | [docs](https://docs.rs/copybook-sequence-ring/${version}) |
          | copybook-overflow | [${version}](https://crates.io/crates/copybook-overflow/${version}) | [docs](https://docs.rs/copybook-overflow/${version}) |
          | copybook-error-reporter | [${version}](https://crates.io/crates/copybook-error-reporter/${version}) | [docs](https://docs.rs/copybook-error-reporter/${version}) |
          | copybook-charset | [${version}](https://crates.io/crates/copybook-charset/${version}) | [docs](https://docs.rs/copybook-charset/${version}) |
          | copybook-governance-contracts | [${version}](https://crates.io/crates/copybook-governance-contracts/${version}) | [docs](https://docs.rs/copybook-governance-contracts/${version}) |
          | copybook-codec-memory | [${version}](https://crates.io/crates/copybook-codec-memory/${version}) | [docs](https://docs.rs/copybook-codec-memory/${version}) |
          | copybook-overpunch | [${version}](https://crates.io/crates/copybook-overpunch/${version}) | [docs](https://docs.rs/copybook-overpunch/${version}) |
          | copybook-utils | [${version}](https://crates.io/crates/copybook-utils/${version}) | [docs](https://docs.rs/copybook-utils/${version}) |
          | copybook-governance-grid | [${version}](https://crates.io/crates/copybook-governance-grid/${version}) | [docs](https://docs.rs/copybook-governance-grid/${version}) |
          | copybook-options | [${version}](https://crates.io/crates/copybook-options/${version}) | [docs](https://docs.rs/copybook-options/${version}) |
          | copybook-governance-runtime | [${version}](https://crates.io/crates/copybook-governance-runtime/${version}) | [docs](https://docs.rs/copybook-governance-runtime/${version}) |
          | copybook-core | [${version}](https://crates.io/crates/copybook-core/${version}) | [docs](https://docs.rs/copybook-core/${version}) |
          | copybook-governance | [${version}](https://crates.io/crates/copybook-governance/${version}) | [docs](https://docs.rs/copybook-governance/${version}) |
          | copybook-fixed | [${version}](https://crates.io/crates/copybook-fixed/${version}) | [docs](https://docs.rs/copybook-fixed/${version}) |
          | copybook-rdw | [${version}](https://crates.io/crates/copybook-rdw/${version}) | [docs](https://docs.rs/copybook-rdw/${version}) |
          | copybook-record-io | [${version}](https://crates.io/crates/copybook-record-io/${version}) | [docs](https://docs.rs/copybook-record-io/${version}) |
          | copybook-codec | [${version}](https://crates.io/crates/copybook-codec/${version}) | [docs](https://docs.rs/copybook-codec/${version}) |
          | copybook-arrow | [${version}](https://crates.io/crates/copybook-arrow/${version}) | [docs](https://docs.rs/copybook-arrow/${version}) |
          | copybook-cli | [${version}](https://crates.io/crates/copybook-cli/${version}) | [docs](https://docs.rs/copybook-cli/${version}) |

          See [CHANGELOG.md](https://github.com/EffortlessMetrics/copybook-rs/blob/${tag}/CHANGELOG.md) for details.`,
            draft: false,
            prerelease: version.includes('-')
          });

          console.log(\`Created release: \${release.html_url}\`);

  smoke-test:
    runs-on: ubuntu-latest
    needs: publish
    steps:
    - uses: dtolnay/rust-toolchain@stable

    - name: Install copybook-cli (default features)
      run: |
        VERSION="${{ github.ref_name || github.event.inputs.tag }}"
        VERSION=${VERSION#v}

        echo "Testing installation of copybook-cli@${VERSION}"
        cargo install copybook-cli@${VERSION} --locked --root /tmp/copybook-default
        /tmp/copybook-default/bin/copybook --version
        /tmp/copybook-default/bin/copybook --help >/dev/null

        echo "Smoke test passed: copybook-cli@${VERSION} installs and runs"

    - name: Install copybook-cli (arrow feature compile check)
      run: |
        VERSION="${{ github.ref_name || github.event.inputs.tag }}"
        VERSION=${VERSION#v}

        echo "Testing installation with --features arrow"
        cargo install copybook-cli@${VERSION} --locked --features arrow --root /tmp/copybook-arrow
        /tmp/copybook-arrow/bin/copybook --version

        echo "Arrow feature resolves from crates.io"

    - name: Validate docs.rs builds
      run: |
        VERSION="${{ github.ref_name || github.event.inputs.tag }}"
        VERSION=${VERSION#v}

        echo "Checking docs.rs availability (may take a few minutes to build)..."

        # Give docs.rs some time to start building
        sleep 300

        # Check if docs are available (docs.rs builds asynchronously)
        for crate in copybook-core copybook-codec copybook-arrow copybook-cli; do
          url="https://docs.rs/${crate}/${VERSION}"
          echo "Docs will be available at: ${url}"
        done

        echo "Documentation links generated. docs.rs builds asynchronously."

  notify-success:
    runs-on: ubuntu-latest
    needs: [publish, smoke-test]
    if: success()
    steps:
    - name: Success notification
      run: |
        VERSION="${{ github.ref_name || github.event.inputs.tag }}"
        VERSION=${VERSION#v}

        echo "Successfully published copybook-rs ${VERSION}!"
        echo ""
        echo "Installation:"
        echo "   cargo install copybook-cli@${VERSION}"
        echo ""
        echo "Documentation:"
        echo "   https://docs.rs/copybook-core/${VERSION}"
        echo "   https://docs.rs/copybook-codec/${VERSION}"
        echo "   https://docs.rs/copybook-arrow/${VERSION}"
        echo "   https://docs.rs/copybook-cli/${VERSION}"
        echo ""
        echo "Crates.io:"
        echo "   https://crates.io/crates/copybook-core"
        echo "   https://crates.io/crates/copybook-codec"
        echo "   https://crates.io/crates/copybook-arrow"
        echo "   https://crates.io/crates/copybook-cli"
