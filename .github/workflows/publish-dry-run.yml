# SPDX-License-Identifier: AGPL-3.0-or-later
name: Publish Dry Run

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to test (e.g., v0.3.1)'
        required: false
        type: string

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  publish-dry-run:
    name: Publish Dry Run
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v6
      with:
        fetch-depth: 0
        ref: ${{ inputs.tag || github.ref }}

    - uses: dtolnay/rust-toolchain@stable

    - uses: Swatinem/rust-cache@v2
      with:
        key: publish-dry-run

    - name: Verify ref context
      run: |
        echo "Testing publish preflight for ref: ${{ inputs.tag || github.ref_name }}"
        git rev-parse HEAD
        git describe --tags --always

    - name: Dry run publish (copybook-core)
      run: |
        echo "ðŸ“¦ Testing copybook-core packaging..."
        cargo publish -p copybook-core --dry-run
        echo "âœ… copybook-core dry-run successful"

    - name: Package manifest check (copybook-codec)
      run: |
        echo "ðŸ“¦ Checking copybook-codec package contents..."
        cargo package -p copybook-codec --list
        echo "âœ… copybook-codec package file list generated"

    - name: Package manifest check (copybook-arrow)
      run: |
        echo "ðŸ“¦ Checking copybook-arrow package contents..."
        cargo package -p copybook-arrow --list
        echo "âœ… copybook-arrow package file list generated"

    - name: Package manifest check (copybook-cli)
      run: |
        echo "ðŸ“¦ Checking copybook-cli package contents..."
        cargo package -p copybook-cli --list
        echo "âœ… copybook-cli package file list generated"

    - name: Summary
      if: success()
      run: |
        echo "ðŸŽ‰ Publish preflight checks passed!"
        echo ""
        echo "Validated:"
        echo "  1. copybook-core: cargo publish --dry-run"
        echo "  2. copybook-codec: cargo package --list"
        echo "  3. copybook-arrow: cargo package --list"
        echo "  4. copybook-cli: cargo package --list"
        echo ""
        echo "Downstream publish dry-runs are run just-in-time in .github/workflows/publish.yml after upstream crates exist on crates.io."
