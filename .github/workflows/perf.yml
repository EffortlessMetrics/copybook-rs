name: Perf Receipts
on:
  pull_request:
    paths:
      - "copybook-bench/**"
      - "copybook-codec/**"
      - "scripts/bench.sh"
      - "scripts/bench.bat"
      - "scripts/guard-hotpaths.sh"
      - "justfile"

concurrency:
  group: perf-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  perf:
    if: ${{ !contains(github.event.pull_request.title || '', '[docs]') }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2
        with:
          save-if: ${{ github.ref == 'refs/heads/main' }}

      - name: Install cargo-nextest
        uses: taiki-e/install-action@v2
        with:
          tool: nextest

      - name: Hot-path guard
        run: bash scripts/guard-hotpaths.sh

      - name: Hygiene and build
        run: |
          cargo fmt --all --check
          cargo clippy --workspace --all-targets --all-features -- -D warnings -W clippy::pedantic
          cargo build --workspace --release
          cargo nextest run --workspace

      - name: Property tests (fast deterministic)
        env:
          PROPTEST_CASES: "256"
          PROPTEST_SEED: ${{ env.PROPTEST_SEED || 'copybook-rs-perf' }}
        run: |
          cargo test -p copybook-codec \
            prop_zoned_digit_buffer_contains_only_digits \
            zoned_overpunch \
            -- --nocapture

      - name: Run benches (JSON)
        run: bash scripts/bench.sh

      - name: Upload perf receipts
        uses: actions/upload-artifact@v4
        with:
          name: perf-json
          path: scripts/bench/perf.json
          retention-days: 90

      - name: Summarize SLOs (robust jq)
        id: slo
        shell: bash
        run: |
          f=scripts/bench/perf.json
          disp=$(jq -r '
            [
              .display_mibps?,
              .metrics?.display_mibps?,
              (.benchmarks[]? | .display_mibps?),
              (.benchmarks[]? | .throughput_mib? | select(. != null))
            ] | map(select(. != null)) | (max // 0)
          ' "$f")

          comp=$(jq -r '
            [
              .comp3_mibps?,
              .metrics?.comp3_mibps?,
              (.benchmarks[]? | .comp3_mibps?),
              (.benchmarks[]? | .comp3_throughput_mib?),
              (.benchmarks[]? | .throughput_mib? | select(. != null and . < 200))
            ] | map(select(. != null)) | (max // 0)
          ' "$f")

          echo "display=$disp" >> "$GITHUB_OUTPUT"
          echo "comp3=$comp"   >> "$GITHUB_OUTPUT"

      - name: Gate on SLOs
        env:
          DISPLAY_MIB: ${{ steps.slo.outputs.display }}
          COMP3_MIB: ${{ steps.slo.outputs.comp3 }}
        run: |
          disp="${DISPLAY_MIB:-0}"
          comp="${COMP3_MIB:-0}"
          rss=$(jq -r '.summary.max_rss_mib // 0' scripts/bench/perf.json)
          echo "display=$disp comp3=$comp max_rss_mib=$rss"
          awk -v d="$disp" -v c="$comp" -v r="$rss" 'BEGIN{
            if (d<80 || c<40 || r>256) {print "SLO FAIL: display=" d " comp3=" c " max_rss_mib=" r; exit 1}
            else {print "SLO PASS: display=" d " comp3=" c " max_rss_mib=" r}
          }'

      - name: Publish check-run (Throughput SLOs)
        if: ${{ success() }}
        uses: actions/github-script@v7
        env:
          DISPLAY_MIB: ${{ steps.slo.outputs.display }}
          COMP3_MIB: ${{ steps.slo.outputs.comp3 }}
        with:
          script: |
            const fs = require('fs');
            const core = require('@actions/core');
            const path = 'scripts/bench/perf.json';
            let maxRss = 'n/a';
            try {
              const data = JSON.parse(fs.readFileSync(path, 'utf8'));
              const summary = data.summary || {};
              if (summary.max_rss_mib != null) {
                maxRss = summary.max_rss_mib;
              }
            } catch (error) {
              core.warning(`Failed to read ${path}: ${error}`);
            }

            const display = process.env.DISPLAY_MIB || '0';
            const comp3 = process.env.COMP3_MIB || '0';
            await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'review:gate:throughput',
              head_sha: context.sha,
              status: 'completed',
              conclusion: 'success',
              output: {
                title: 'Throughput SLOs',
                summary:
                  `DISPLAY: ${display} MiB/s (>=80)\n` +
                  `COMP-3:  ${comp3} MiB/s (>=40)\n` +
                  `Max RSS: ${maxRss} MiB (<=256)`
              }
            });

      - name: Label perf success
        if: ${{ success() && github.event.pull_request.number }}
        uses: actions/github-script@v7
        with:
          script: |
            const core = require('@actions/core');
            const label = 'ready:perf-ok';
            try {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                labels: [label],
              });
            } catch (error) {
              core.warning(`Unable to add ${label}: ${error.message}`);
            }

      - name: Job summary
        if: ${{ always() }}
        run: |
          echo "### Throughput SLOs" >> "$GITHUB_STEP_SUMMARY"
          if [[ -f scripts/bench/perf.json ]]; then
            echo "- DISPLAY: ${{ steps.slo.outputs.display }} MiB/s (>= 80)" >> "$GITHUB_STEP_SUMMARY"
            echo "- COMP-3:  ${{ steps.slo.outputs.comp3 }} MiB/s (>= 40)" >> "$GITHUB_STEP_SUMMARY"
            echo "- Max RSS: $(jq -r '.summary.max_rss_mib // "n/a"' scripts/bench/perf.json) MiB (<= 256)" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "- Receipts missing; see logs for details." >> "$GITHUB_STEP_SUMMARY"
          fi
