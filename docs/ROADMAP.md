# copybook-rs Roadmap

**Status:** ‚ö†Ô∏è Engineering Preview (v0.4.2-dev on main; v0.4.1 latest tag)

> **Canonical Status Source**: This file is the authoritative reference
> for copybook-rs project status, adoption guidance, and development timeline.
> For detailed technical assessment, see [REPORT.md](REPORT.md).

This roadmap tracks **what we will ship**, **how we'll measure it**, and
**when it's done**. Each milestone has: Objectives ‚Üí Deliverables ‚Üí Exit
Criteria ‚Üí Risks/Mitigations.

---

## Principles (keep these stable)

* **Stability first**: No breaking public behaviors without a minor+ bump;
  hold API freeze before v1.0.
* **Performance budgeted**: Track throughput against realistic MiB/s floors
  (targets) and document regressions; v0.4.0 treats floors as advisory-only
  until CI perf gating is stable.
* **Single source of truth**: Raw performance receipts live in
  `scripts/bench/perf.json` (generated by `scripts/bench.sh`); public docs
  emphasize correctness and limitations. A sample file
  (`scripts/bench/test_perf.sample.json`) exists for tooling references.
* **Determinism**: Parallel decode remains deterministic; round-trip remains
  lossless.

---

## Milestone v0.4.0 ‚Äî Distribution & CI (v0.4.0)

### Objectives

‚úÖ Make installation trivial; make performance visible in PRs; lock structural
semantics with fixtures.

### Deliverables

1. **‚úÖ Crates.io publish** (`core`, `codec`, `cli`) ‚Äî **Tagged (publish pending)**

   * ‚úÖ crate metadata: categories, keywords, readme path, license files
     included
   * ‚úÖ workspace dependencies configured for version-based publishing
     (=0.4.0)
   * ‚úÖ publish dry-run validation in CI
   * ‚úÖ automated publish workflow for tagged releases
     (core ‚Üí codec ‚Üí cli)
   * üîÑ docs.rs builds for all crates (will complete after first publish)

2. **‚úÖ Bench receipts tooling** (#52) ‚Äî **COMPLETED**

   * ‚úÖ `bench-report` CLI tool with baseline management (validate, promote,
     compare, summary)
   * ‚úÖ criterion JSON parsing with real throughput calculation
   * ‚ùå PR comment automation: SLO deltas and pass/fail against budgets
     (¬±5% warn, >10% fail)
   * ‚úÖ Upload receipts to GitHub Actions artifacts (`perf-json`,
     90-day retention)
   * ‚úÖ DISPLAY/COMP-3 metric extraction from benchmark results

3. **‚úÖ Golden fixtures** (#53) ‚Äî **COMPLETED**

   * ‚úÖ `level-88 after ODO` (pass) - validates non-storage fields after ODO
   * ‚úÖ `child-inside-ODO` (pass) - validates inner field access
   * ‚úÖ `storage sibling after ODO` (fail) - enforces structural constraints
   * ‚úÖ ODO with nested structure (pass) - validates complex hierarchies
   * ‚úÖ Multiple ODO violation (fail) - enforces tail constraints

4. **‚úÖ Docs nav + link hygiene** ‚Äî **COMPLETED**

   * ‚úÖ Documentation navigation table in README
   * ‚úÖ `docs/CLI_REFERENCE.md` exists with complete command reference
   * ‚úÖ Performance number consolidation: single source of truth
   * ‚úÖ All duplicate perf numbers replaced with canonical links

### Exit Criteria ‚ö†Ô∏è PARTIAL

* ‚úÖ `cargo publish` sequence ready; core dry-run passes; codec/cli dry-run
  after upstream crates exist on crates.io
* ‚úÖ Version pinned (0.4.0) with exact internal dependencies
* ‚úÖ Golden fixtures all pass; structural constraints properly validated
* ‚úÖ Benchmark tooling implemented (`bench-report` CLI with baseline
  management)
* ‚ùå CI integration: PR comments and artifact uploads not yet automated
* ‚úÖ Documentation audit complete: no duplicate perf numbers, working
  navigation

### Status: ‚ö†Ô∏è Tagged (publish pending)

**Tagged**: 2025-12-18 (v0.4.0)

**Includes**: Projection (`--select`) support, edited PIC decode (E1/E2),
deterministic JSON output, golden fixtures validation, docs navigation
refresh, bench-report CLI

**Outstanding**: GitHub Actions integration (PR comments, artifact uploads);
SLO enforcement automation

**Note**: If fixes land after the tag, prefer a patch release (`v0.4.1`) over
moving `v0.4.0`.

---

## Milestone v0.5.0 ‚Äî Edited PIC Encoding & Dialects (Q1 2026)

### Objectives

* Implement Edited PIC Encoding (Phase E3) ‚Äî biggest functional gap
* Add a safe, explicit knob for ODO bounds across COBOL dialects; squeeze
  throughput without changing outputs.
* Complete Determinism CI Wiring (Phase 3) ‚Äî Phases 1-2 already shipped

### Deliverables

1. **Edited PIC E3 encode** ‚Äî **BIGGEST FUNCTIONAL GAP**

   * **E3.0 ‚Äî Contract + Test Matrix PR** (docs-only)
     * Define supported patterns table (sign placement, Z/0, decimal point,
       commas, currency, CR/DB)
     * Define error handling strategy (what returns "unsupported edited PIC
       encode" error)
   * **E3.1 ‚Äî Minimal Encode Path** (sign + basic Z/0)
     * Scope: digit placement, decimal point, sign placement
     * Tests: golden fixtures for representative formats
   * **E3.2 ‚Äî Sign Editing (+/-)** (leading/trailing)
     * Scope: sign placement rules, CR/DB formatting
     * Tests: fixtures for positive/negative signs
   * **E3.3 ‚Äî CR/DB** (currency symbols)
     * Scope: `$` currency, comma grouping, `*` fill
     * Tests: fixtures for currency formats
   * **E3.4 ‚Äî Commas & Separators** (`,`, `/`, `.`, spaces)
     * Scope: comma placement, decimal point handling
     * Tests: fixtures for comma placement
   * **E3.5 ‚Äî Asterisk Fill (`*`)** (check protection)
     * Scope: asterisk fill for zero values
     * Tests: fixtures for check protection behavior
   * **E3.6 ‚Äî Currency Symbols** (`$`, floating currency)
     * Scope: currency symbol placement
     * Tests: fixtures for currency placement

2. **Dialect lever** (#51) ‚Äî **ENTERPRISE CORRECTNESS KNOB**

   * **D.0 ‚Äî Config Schema** (docs-only PR)
     * Define config key and allowed values
     * CLI flag and env var mapping
     * Default behavior unchanged (`"n"`)
   * **D.1 ‚Äî Core Implementation** (core-only PR)
     * ODO lower bound validation in layout.rs
     * Default behavior preserved
   * **D.2 ‚Äî CLI Integration** (CLI-only PR)
     * Parse flag wiring into options
     * Env var support
   * **D.3 ‚Äî Golden Fixtures** (test-only PR)
     * Same copybook validated under each dialect setting
     * Documented behavioral differences
   * **D.4 ‚Äî Docs & Examples** (docs-only PR)
     * Migration notes for existing users
     * Example copybooks showing dialect differences

3. **Determinism Validation** (#112) ‚Äî **‚úÖ Phases 1‚Äì2 SHIPPED**

   * [x] Phase 1 ‚Äì Codec harness (PR #158)
     * `copybook_codec::determinism` module
     * BLAKE3 hashes + bounded byte diffs
     * Adversarial tests for error paths and edge cases
   * [x] Phase 2 ‚Äì CLI wiring (PR #160)
     * `copybook determinism decode|encode|round-trip`
     * Human + JSON output modes
     * Integration tests in `copybook-cli/tests/determinism_cli.rs`
   * [x] Phase 3 ‚Äì CI smoke test template (READY, awaiting CI re-enable)
     * `.github/workflows/determinism-smoke.yml` workflow template
     * `scripts/ci/determinism_smoke.sh` executable script (runs locally)
     * Tests both DISPLAY-heavy (`simple.cpy`) and COMP-3
       (`comp3_test.cpy`) fixtures
     * Emits machine-readable JSON receipts for CI parsing
     * Advisory-only when activated (non-blocking), promotable to blocking
       gate

4. **Perf tune (SIMD/I/O)**

   * Target +10‚Äì20% p95 throughput maintained under budgets; no API/behavior
     changes

### Exit Criteria

* **Edited PIC E3 encode**: All E3.0‚ÄìE3.6 phases complete; golden fixtures
  pass for sign, CR/DB, commas, asterisk fill, and currency symbols
* **Dialect lever**: Same inputs under each dialect mode produce
  **documented** and **tested** outcomes; default behavior unchanged
* **Determinism CI**: Phase 3 smoke test active (awaiting CI re-enable)
* No regressions vs v0.3.0 budgets; CI receipts show deltas ‚â§ 5% except where
  improved
* Default behavior unchanged (back-compat preserved)

### Risks & Mitigations

* **Edited PIC encode complexity** ‚Üí incremental phases (E3.0‚ÄìE3.6) with
  golden fixtures; clear error handling for unsupported patterns
* **Behavior drift for existing users** ‚Üí default remains current `"n"` for
  dialect lever; strong docs + examples

---

## Toward v1.0.0 ‚Äî Stability & Ecosystem (Q2 2026)

### Objectives

* Lock public behaviors, add first-class connectors.

### Deliverables

* **API freeze window** (4 weeks): only doc/bench/test changes
* **Ecosystem adapters** (best-effort): Arrow/Parquet writer crate prototype,
  Kafka example pipeline
* **Support policy**: 6-month minor support window; security patches anytime

### Exit Criteria

* Changelog & README carry a "**Stability Guarantees**" section
* Example integrations build in CI; round-trip and perf budgets still
  satisfied

---

## Telemetry Rollout (Phase 6)

**Status:** Done ‚Äî staging exporter live; dashboards + alerts active.

**Why:** make runtime behavior observable with a rollback lever.

### Plan

* [x] Feature-gate metrics; exporter behind `--metrics-listen`
* [x] Emit low-cardinality series in decode path
* [x] README + Library API docs
* [x] Staging rollout (enable flag; Prom scrape)
* [x] Dashboards (QPS, bytes/s, error rate, MiB/s)
* [x] Alerts (error burst, throughput drop)
* [x] Perf sanity on staging (MiB/s, RSS in-band)

**Exit:** `/metrics` reachable; Prom scraping; dashboards green; SLO receipts
steady; builds clean with/without metrics.

---

## Project board & labels

* **Board columns**: Backlog ‚Üí In Progress ‚Üí In Review ‚Üí Bench Verified ‚Üí
  Done
* **Labels**: `area:parser`, `area:bench`, `area:docs`, `type:feature`,
  `type:bug`, `type:tests`, `perf:budget-regression`
* **Rules**:
  * Anything touching hot paths must pass **Bench Verified** before **Done**
  * Any PR adding perf numbers must **not** repeat them‚Äîlink to canonical
    section

---

## Release train

* **Minor**: every 6‚Äì8 weeks (feature batches)
* **Patch**: as-needed (bug or doc only)
* **Pre-release checklist**: `cargo build -r` ‚Ä¢ `nextest` ‚Ä¢ `bench receipts`
  ‚Ä¢ link check ‚Ä¢ changelog ‚Ä¢ tag ‚Ä¢ GitHub release

---

## Owner matrix (example; edit as you like)

| Area              | DRI        | Backup     |
| ----------------- | ---------- | ---------- |
| Parser & dialects | @you       | @contrib-A |
| Codec & perf      | @you       | @contrib-B |
| CLI & docs        | @contrib-C | @you       |
| CI/bench receipts | @contrib-D | @contrib-C |

---

## Paste-ready CI snippets

### Bench receipts (GitHub Actions)

```yaml
- name: Run benches
  run: |
    PERF=1 cargo bench -p copybook-bench \
      -- --output-format bencher | tee bench.out

- name: Roll up perf JSON
  run: |
    python3 - << 'PY'
    import json,glob
    from pathlib import Path
    reports=list(
      glob.glob('target/criterion/**/new/benchmark.json',
      recursive=True))
    out={"display_mib_per_s":None,"comp3_mib_per_s":None}
    # Parse actual metric keys and set SLOs (implementation detail)
    Path('perf.json').write_text(json.dumps(out))
    PY

- name: Upload artifacts
  uses: actions/upload-artifact@v4
  with:
    name: bench-artifacts
    path: |
      perf.json
      target/criterion/**
    retention-days: 14

- name: Comment perf summary
  if: ${{ github.event_name == 'pull_request' }}
  run: |
    gh pr comment ${{ github.event.pull_request.number }} \
      --body "$(cat perf.json)"
```

### SLO gate (simple)

```yaml
- name: Enforce SLOs
  run: |
    python3 - << 'PY'
    import json,sys
    with open('perf.json') as fh:
        data=json.load(fh)
    if data.get("display_mib_per_s",0) < 80:
        sys.exit("DISPLAY throughput below 80 MiB/s floor")
    if data.get("comp3_mib_per_s",0) < 40:
        sys.exit("COMP-3 throughput below 40 MiB/s floor")
    PY
```

---

## Technical Debt Tracking (Dec 2024 Audit)

The following items were identified during comprehensive codebase exploration
and are tracked for future sprints:

### Documentation (Medium Priority)

* [ ] Document 22 numeric functions in `copybook-codec/src/numeric.rs`
* [ ] Add API documentation for memory module (`ScratchBuffers`,
  `SequenceRing`, `WorkerPool`)
* [ ] Add usage examples to iterator module public functions

### Test Coverage (Future Sprints)

* [ ] Add dedicated tests for 9 untested error codes (CBKS701-703,
  CBKD101, CBKE510/515, CBKF102/104, CBKI001)
* [ ] Add unit tests for memory/iterator infrastructure
* [ ] Improve audit feature test coverage (currently ~10%)

### Code Quality (Completed in v0.4.0+)

* [x] Consolidate CLI command duplication (`parse_selectors`, `ParseOptions`,
  field projection)
* [x] Fix deprecated `cargo_bin` function in xtask tests
* [x] Standardize workspace dependency inheritance (`sha2`, `chrono` in
  `copybook-gen`)
* [x] **Production panics at 0** on main (test-only panics remain acceptable)

### CI Mode (Current)

* **CI-off operating mode**: Local gates + small PRs + explicit receipts in PR bodies
* **Dispatch-only workflows**: Mutants, fuzz, SBOM are dispatch-only until CI is re-enabled
* **Manual validation**: Run workflows once when CI returns to validate artifact upload paths and runtime budgets

### Distribution

* **crates.io** = Public artifact distribution (crate tarball becomes public)
* **Internal/Private distribution**: Git tags on private repositories, private cargo registries
* **Note**: `cargo publish --dry-run` for workspace crates may fail for codec/cli prior to publishing core/codec (verification builds in isolation). Use `cargo package --no-verify` to inspect tarball contents.

---

## Definition of Done (all milestones)

* ‚úÖ Tests green (unit/integration/golden fixtures)
* ‚úÖ Bench receipts uploaded; budgets respected
* ‚úÖ Docs updated (no duplicated performance figures)
* ‚úÖ Changelog entry & tag created
