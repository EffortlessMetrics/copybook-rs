# SPDX-License-Identifier: AGPL-3.0-or-later
# Example GitHub Actions workflow for validating Kubernetes manifests
# Copy this to .github/workflows/k8s-validate.yml to enable CI validation

name: Kubernetes Manifest Validation

on:
  pull_request:
    paths:
      - 'deploy/kubernetes/**'
  push:
    branches:
      - main
    paths:
      - 'deploy/kubernetes/**'

jobs:
  validate-manifests:
    name: Validate Kubernetes Manifests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'v1.29.0'

      - name: Validate deployment.yaml
        run: |
          kubectl apply --dry-run=client -f deploy/kubernetes/deployment.yaml

      - name: Validate base kustomization
        run: |
          kubectl kustomize deploy/kubernetes/

      - name: Validate dev overlay
        run: |
          kubectl kustomize deploy/kubernetes/overlays/dev/

      - name: Validate staging overlay
        run: |
          kubectl kustomize deploy/kubernetes/overlays/staging/

      - name: Validate production overlay
        run: |
          kubectl kustomize deploy/kubernetes/overlays/production/

      - name: Validate job manifests
        run: |
          kubectl apply --dry-run=client -f deploy/kubernetes/jobs/decode-job.yaml
          kubectl apply --dry-run=client -f deploy/kubernetes/jobs/encode-job.yaml
          kubectl apply --dry-run=client -f deploy/kubernetes/jobs/verify-job.yaml
          kubectl apply --dry-run=client -f deploy/kubernetes/jobs/determinism-job.yaml
          kubectl apply --dry-run=client -f deploy/kubernetes/jobs/cronjob-example.yaml

      - name: Run validation script
        run: |
          cd deploy/kubernetes
          ./validate.sh

      - name: Kubeval validation (optional)
        if: false  # Enable by setting to true
        run: |
          # Install kubeval
          wget https://github.com/instrumenta/kubeval/releases/latest/download/kubeval-linux-amd64.tar.gz
          tar xf kubeval-linux-amd64.tar.gz
          sudo mv kubeval /usr/local/bin

          # Validate with kubeval
          kubectl kustomize deploy/kubernetes/ | kubeval --strict

  security-scan:
    name: Security Scan with Kubesec
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Kubesec Scanner
        uses: controlplaneio/kubesec-action@v0.0.2
        with:
          input: deploy/kubernetes/deployment.yaml
          format: json

  lint-manifests:
    name: Lint with kube-linter
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup kube-linter
        run: |
          wget https://github.com/stackrox/kube-linter/releases/download/v0.6.8/kube-linter-linux.tar.gz
          tar xf kube-linter-linux.tar.gz
          sudo mv kube-linter /usr/local/bin

      - name: Lint Kubernetes manifests
        run: |
          kube-linter lint deploy/kubernetes/deployment.yaml \
            --config deploy/kubernetes/.kube-linter.yaml || true
          # Note: Allow failures for now; fix linting issues incrementally

  test-kustomize-overlays:
    name: Test Kustomize Overlays
    runs-on: ubuntu-latest

    strategy:
      matrix:
        overlay: [dev, staging, production]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'v1.29.0'

      - name: Build ${{ matrix.overlay }} overlay
        run: |
          kubectl kustomize deploy/kubernetes/overlays/${{ matrix.overlay }}/

      - name: Validate ${{ matrix.overlay }} overlay
        run: |
          kubectl kustomize deploy/kubernetes/overlays/${{ matrix.overlay }}/ | \
            kubectl apply --dry-run=client -f -

      - name: Check resource limits
        run: |
          # Extract memory limits from overlay
          MEMORY_LIMIT=$(kubectl kustomize deploy/kubernetes/overlays/${{ matrix.overlay }}/ | \
            grep -A 10 "resources:" | grep "memory:" | tail -1 | awk '{print $2}')
          echo "Memory limit for ${{ matrix.overlay }}: ${MEMORY_LIMIT}"

          # Validate minimum memory requirements
          case "${{ matrix.overlay }}" in
            dev)
              echo "Dev overlay: memory should be 256Mi"
              ;;
            staging)
              echo "Staging overlay: memory should be 384Mi"
              ;;
            production)
              echo "Production overlay: memory should be 512Mi"
              ;;
          esac
