name: Publish Crates

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to publish (e.g., v0.3.1)'
        required: true
        type: string

permissions:
  contents: write
  id-token: write

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  publish:
    runs-on: ubuntu-latest
    environment: production
    steps:
    - uses: actions/checkout@v5
      with:
        fetch-depth: 0

    - uses: dtolnay/rust-toolchain@stable
    - uses: Swatinem/rust-cache@v2
      with:
        key: publish

    - name: Preflight checks
      run: |
        echo "Publishing for tag: ${{ github.ref_name || github.event.inputs.tag }}"

        # Verify workspace builds cleanly
        cargo build --workspace --release

        # Run tests to ensure quality
        cargo test --workspace --release

        # Verify all publishable crates package correctly
        cargo package -p copybook-core --allow-dirty
        cargo package -p copybook-codec --allow-dirty
        cargo package -p copybook-cli --allow-dirty

    - name: Publish copybook-core
      env:
        CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
      run: |
        echo "Publishing copybook-core..."
        cargo publish -p copybook-core
        echo "âœ… copybook-core published successfully"

    - name: Wait for crates.io index propagation
      run: |
        echo "Waiting 90 seconds for crates.io index to propagate..."
        sleep 90

    - name: Publish copybook-codec
      env:
        CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
      run: |
        echo "Publishing copybook-codec..."
        cargo publish -p copybook-codec
        echo "âœ… copybook-codec published successfully"

    - name: Wait for crates.io index propagation
      run: |
        echo "Waiting 90 seconds for crates.io index to propagate..."
        sleep 90

    - name: Publish copybook-cli
      env:
        CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
      run: |
        echo "Publishing copybook-cli..."
        cargo publish -p copybook-cli
        echo "âœ… copybook-cli published successfully"

    - name: Create GitHub Release
      uses: actions/github-script@v8
      with:
        script: |
          const tag = '${{ github.ref_name || github.event.inputs.tag }}';
          const version = tag.replace('v', '');

          const { data: release } = await github.rest.repos.createRelease({
            owner: context.repo.owner,
            repo: context.repo.repo,
            tag_name: tag,
            name: `copybook-rs ${version}`,
            body: `## copybook-rs ${version}

          **Installation:**
          \`\`\`bash
          cargo install copybook-cli@${version}
          \`\`\`

          **Crates:**
          - [copybook-core ${version}](https://crates.io/crates/copybook-core/${version})
          - [copybook-codec ${version}](https://crates.io/crates/copybook-codec/${version})
          - [copybook-cli ${version}](https://crates.io/crates/copybook-cli/${version})

          **Documentation:**
          - [copybook-core docs](https://docs.rs/copybook-core/${version})
          - [copybook-codec docs](https://docs.rs/copybook-codec/${version})
          - [copybook-cli docs](https://docs.rs/copybook-cli/${version})

          See [CHANGELOG.md](https://github.com/EffortlessMetrics/copybook-rs/blob/main/CHANGELOG.md) for details.`,
            draft: false,
            prerelease: version.includes('-')
          });

          console.log(\`Created release: \${release.html_url}\`);

  smoke-test:
    runs-on: ubuntu-latest
    needs: publish
    steps:
    - uses: dtolnay/rust-toolchain@stable

    - name: Test installation in clean environment
      run: |
        # Create temporary project to test installation
        cargo new /tmp/copybook-smoke-test
        cd /tmp/copybook-smoke-test

        # Extract version from tag
        VERSION="${{ github.ref_name || github.event.inputs.tag }}"
        VERSION=${VERSION#v}  # Remove 'v' prefix

        echo "Testing installation of copybook-cli@${VERSION}"

        # Test cargo add works
        cargo add copybook-cli@${VERSION}

        # Test build works
        cargo build --quiet

        echo "âœ… Smoke test passed: cargo add copybook-cli@${VERSION} works"

    - name: Validate docs.rs builds
      run: |
        VERSION="${{ github.ref_name || github.event.inputs.tag }}"
        VERSION=${VERSION#v}

        echo "Checking docs.rs availability (may take a few minutes to build)..."

        # Give docs.rs some time to start building
        sleep 300

        # Check if docs are available (docs.rs builds asynchronously)
        for crate in copybook-core copybook-codec copybook-cli; do
          url="https://docs.rs/${crate}/${VERSION}"
          echo "Docs will be available at: ${url}"
        done

        echo "âœ… Documentation links generated. docs.rs builds asynchronously."

  notify-success:
    runs-on: ubuntu-latest
    needs: [publish, smoke-test]
    if: success()
    steps:
    - name: Success notification
      run: |
        VERSION="${{ github.ref_name || github.event.inputs.tag }}"
        VERSION=${VERSION#v}

        echo "ðŸš€ Successfully published copybook-rs ${VERSION}!"
        echo ""
        echo "ðŸ“¦ Installation:"
        echo "   cargo install copybook-cli@${VERSION}"
        echo ""
        echo "ðŸ“š Documentation:"
        echo "   https://docs.rs/copybook-core/${VERSION}"
        echo "   https://docs.rs/copybook-codec/${VERSION}"
        echo "   https://docs.rs/copybook-cli/${VERSION}"
        echo ""
        echo "ðŸ”— Crates.io:"
        echo "   https://crates.io/crates/copybook-core"
        echo "   https://crates.io/crates/copybook-codec"
        echo "   https://crates.io/crates/copybook-cli"