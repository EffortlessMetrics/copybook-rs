# copybook-rs Roadmap

**Status:** âš ï¸ Engineering Preview (v0.4.2-dev on main; v0.4.1 latest tag)
**Last Updated**: 2025-12-31

> **Canonical Status Source**: This file is the authoritative reference
> for copybook-rs project status, adoption guidance, and development timeline.
> For detailed technical assessment, see [REPORT.md](REPORT.md).

This roadmap tracks **what we will ship**, **how we'll measure it**, and
**when it's done**. Each milestone has: Objectives â†’ Deliverables â†’ Exit
Criteria â†’ Risks/Mitigations.

---

## Recent Progress (Dec 2025)

| Commit/PR | Feature | Impact |
|-----------|---------|--------|
| WIP | **E3.2-E3.6 Edited PIC Encoding** | Full encode support: CR/DB, commas, asterisk, currency (115 new tests) |
| WIP | **RENAMES Codec** (#110) | R1-R3 decode/encode with 7 codec-layer tests |
| `976ca0f` | **E3.1 Edited PIC Encoding** | Numeric field encoding with Z-editing, decimal point, basic sign |
| `a9609af` | **D0 Dialect Lever Contract** | `Dialect::Strict`/`Tolerant` with 929 lines of tests |
| PR #172 | **N1 Nested ODO Design** | O5/O6 rejection with `CBKP022`/`CBKP023` error codes |
| PR #182 | **Panic Elimination** | 0 production panics on main |
| PR #162, #163 | **RENAMES R2/R3** | Group resolver + alias API |
| PR #158, #160 | **Determinism Phases 1-2** | Codec harness + CLI validation |

**Test Status**: 1135+ passing (cargo test --workspace)

---

## Roadmap Gap Analysis (Dec 2025)

| Gap | Status | Effort | Blocker |
|-----|--------|--------|---------|
| **E3.2-E3.6** Edited PIC encode | âœ… Complete | - | None |
| **D0-D4** Dialect lever | âœ… Complete | - | None (all shipped) |
| **RENAMES codec** (#110) | âœ… Complete | - | None (R1-R3 implemented) |
| **Determinism CI** (#112 Phase 3) | âœ… Ready | 0.5 PD | CI-off mode |
| **Quality gates** (#97-100) | â³ Blocked | 6-8 weeks | CI-off mode |
| **Benchmark container** (#113) | âœ… Complete | - | None (close issue) |

**Issues to close**: #113 (benchmark container), #51 (dialect lever), #110 (RENAMES codec)

---

## Principles (keep these stable)

* **Stability first**: No breaking public behaviors without a minor+ bump;
  hold API freeze before v1.0.
* **Performance budgeted**: Track throughput against realistic MiB/s floors
  (targets) and document regressions; v0.4.0 treats floors as advisory-only
  until CI perf gating is stable.
* **Single source of truth**: Raw performance receipts live in
  `scripts/bench/perf.json` (generated by `scripts/bench.sh`); public docs
  emphasize correctness and limitations. A sample file
  (`scripts/bench/test_perf.sample.json`) exists for tooling references.
* **Determinism**: Parallel decode remains deterministic; round-trip remains
  lossless.

---

## Milestone v0.4.0 â€” Distribution & CI (v0.4.0)

### Objectives

âœ… Make installation trivial; make performance visible in PRs; lock structural
semantics with fixtures.

### Deliverables

1. **âœ… Crates.io publish** (`core`, `codec`, `cli`) â€” **Released**

   * âœ… crate metadata: categories, keywords, readme path, license files
     included
   * âœ… workspace dependencies configured for version-based publishing
     (=0.4.0)
   * âœ… publish dry-run validation in CI
   * âœ… automated publish workflow for tagged releases
     (core â†’ codec â†’ cli)
   * ğŸ”„ docs.rs builds for all crates (will complete after first publish)

2. **âœ… Bench receipts tooling** (#52) â€” **COMPLETED**

   * âœ… `bench-report` CLI tool with baseline management (validate, promote,
     compare, summary)
   * âœ… criterion JSON parsing with real throughput calculation
   * âŒ PR comment automation: SLO deltas and pass/fail against budgets
     (Â±5% warn, >10% fail)
   * âœ… Upload receipts to GitHub Actions artifacts (`perf-json`,
     90-day retention)
   * âœ… DISPLAY/COMP-3 metric extraction from benchmark results

3. **âœ… Golden fixtures** (#53) â€” **COMPLETED**

   * âœ… `level-88 after ODO` (pass) - validates non-storage fields after ODO
   * âœ… `child-inside-ODO` (pass) - validates inner field access
   * âœ… `storage sibling after ODO` (fail) - enforces structural constraints
   * âœ… ODO with nested structure (pass) - validates complex hierarchies
   * âœ… Multiple ODO violation (fail) - enforces tail constraints

4. **âœ… Docs nav + link hygiene** â€” **COMPLETED**

   * âœ… Documentation navigation table in README
   * âœ… `docs/CLI_REFERENCE.md` exists with complete command reference
   * âœ… Performance number consolidation: single source of truth
   * âœ… All duplicate perf numbers replaced with canonical links

### Exit Criteria âš ï¸ PARTIAL

* âœ… `cargo publish` sequence ready; core dry-run passes; codec/cli dry-run
  after upstream crates exist on crates.io
* âœ… Version pinned (0.4.0) with exact internal dependencies
* âœ… Golden fixtures all pass; structural constraints properly validated
* âœ… Benchmark tooling implemented (`bench-report` CLI with baseline
  management)
* âŒ CI integration: PR comments and artifact uploads not yet automated
* âœ… Documentation audit complete: no duplicate perf numbers, working
  navigation

### Status: âœ… Released

**Released**: 2025-12-18 (v0.4.0)

**Includes**: Projection (`--select`) support, edited PIC decode (E1/E2),
deterministic JSON output, golden fixtures validation, docs navigation
refresh, bench-report CLI

**Follow-up**: v0.4.1 released with additional fixes

---

## Milestone v0.5.0 â€” Edited PIC Encoding & Dialects (Q1 2026)

### Objectives

* Implement Edited PIC Encoding (Phase E3) â€” biggest functional gap
* Add a safe, explicit knob for ODO bounds across COBOL dialects; squeeze
  throughput without changing outputs.
* Complete Determinism CI Wiring (Phase 3) â€” Phases 1-2 already shipped

### Deliverables

1. **Edited PIC E3 encode** â€” **âœ… COMPLETE**

   * **âœ… E3.0 â€” Contract + Test Matrix PR** (docs-only) â€” **COMPLETED**
     * âœ… Define supported patterns table (sign placement, Z/0, decimal point,
       commas, currency, CR/DB)
     * âœ… Define error handling strategy (what returns "unsupported edited PIC
       encode" error)
   * **âœ… E3.1 â€” Minimal Encode Path** (sign + basic Z/0) â€” **COMPLETED** (commit 976ca0f)
     * âœ… Scope: digit placement, decimal point, sign placement
     * âœ… Tests: 920+ lines of golden fixtures for representative formats
     * âœ… Implemented: `encode_edited_numeric()` in copybook-codec
   * **âœ… E3.2 â€” Sign Editing (+/-)** (leading/trailing) â€” **COMPLETED**
     * âœ… Scope: trailing plus/minus sign encoding
     * âœ… Tests: 24 test cases for sign patterns
   * **âœ… E3.3 â€” CR/DB** (credit/debit indicators) â€” **COMPLETED**
     * âœ… Scope: CR/DB sign indicators (2-char trailing)
     * âœ… Tests: 20 test cases for credit/debit patterns
   * **âœ… E3.4 â€” Commas & Separators** (`,`, `/`) â€” **COMPLETED**
     * âœ… Scope: comma placement, slash for dates
     * âœ… Tests: 26 test cases for separator patterns
   * **âœ… E3.5 â€” Asterisk Fill (`*`)** (check protection) â€” **COMPLETED**
     * âœ… Scope: asterisk fill for leading zeros
     * âœ… Tests: 28 test cases for check protection
   * **âœ… E3.6 â€” Currency Symbols** (`$`, fixed position) â€” **COMPLETED**
     * âœ… Scope: fixed-position currency symbol
     * âœ… Tests: 17 test cases for currency patterns

2. **Dialect lever** (#51) â€” **âœ… COMPLETE**

   * **âœ… D.0 â€” Config Schema + Contract** â€” **COMPLETED** (commit a9609af)
     * âœ… Define config key and allowed values (`Dialect::Strict`, `Dialect::Tolerant`)
     * âœ… Core `copybook_core::dialect` module with `Dialect` enum
     * âœ… `effective_min_count()` function for ODO lower bound computation
     * âœ… 581 lines of D1 core tests (`dialect_d1_tests.rs`)
     * âœ… 287 lines of D2 CLI tests (`dialect_cli_d2_tests.rs`)
     * âœ… 61 lines of D3 golden fixtures tests (`dialect_fixtures_d3_tests.rs`)
     * âœ… Normative fixtures: `dialect_normative.bin`, `dialect_zero_tolerant.bin`, `dialect_one_tolerant.bin`
   * **D.1 â€” Core Implementation** (core-only PR) â€” **âœ… COMPLETED** (included in D.0)
     * âœ… ODO lower bound validation in layout.rs
     * âœ… Default behavior preserved (strict mode = `"n"` interpretation)
   * **âœ… D.2 â€” CLI Integration** â€” **COMPLETED** (included in D.0)
     * âœ… `--dialect n|0|1` flags on all commands (parse, inspect, decode, encode, verify)
     * âœ… `COPYBOOK_DIALECT` env var support with proper precedence
     * âœ… 287 lines of CLI tests in `dialect_cli_d2_tests.rs`
   * **âœ… D.3 â€” Golden Fixtures** â€” **COMPLETED** (included in D.0)
     * Same copybook validated under each dialect setting
     * Documented behavioral differences
   * **D.4 â€” Docs & Examples** (docs-only PR)
     * Migration notes for existing users
     * Example copybooks showing dialect differences

3. **Determinism Validation** (#112) â€” **âœ… Phases 1â€“2 SHIPPED**

   * [x] Phase 1 â€“ Codec harness (PR #158)
     * `copybook_codec::determinism` module
     * BLAKE3 hashes + bounded byte diffs
     * Adversarial tests for error paths and edge cases
   * [x] Phase 2 â€“ CLI wiring (PR #160)
     * `copybook determinism decode|encode|round-trip`
     * Human + JSON output modes
     * Integration tests in `copybook-cli/tests/determinism_cli.rs`
   * [x] Phase 3 â€“ CI smoke test template (READY, awaiting CI re-enable)
     * `.github/workflows/determinism-smoke.yml` workflow template
     * `scripts/ci/determinism_smoke.sh` executable script (runs locally)
     * Tests both DISPLAY-heavy (`simple.cpy`) and COMP-3
       (`comp3_test.cpy`) fixtures
     * Emits machine-readable JSON receipts for CI parsing
     * Advisory-only when activated (non-blocking), promotable to blocking
       gate

4. **Perf tune (SIMD/I/O)**

   * Target +10â€“20% p95 throughput maintained under budgets; no API/behavior
     changes

### Exit Criteria

* **Edited PIC E3 encode**: All E3.0â€“E3.6 phases complete; golden fixtures
  pass for sign, CR/DB, commas, asterisk fill, and currency symbols
* **Dialect lever**: Same inputs under each dialect mode produce
  **documented** and **tested** outcomes; default behavior unchanged
* **Determinism CI**: Phase 3 smoke test active (awaiting CI re-enable)
* No regressions vs v0.3.0 budgets; CI receipts show deltas â‰¤ 5% except where
  improved
* Default behavior unchanged (back-compat preserved)

### Risks & Mitigations

* **Edited PIC encode complexity** â†’ incremental phases (E3.0â€“E3.6) with
  golden fixtures; clear error handling for unsupported patterns
* **Behavior drift for existing users** â†’ default remains current `"n"` for
  dialect lever; strong docs + examples

---

## Toward v1.0.0 â€” Stability & Ecosystem (Q2 2026)

### Objectives

* Lock public behaviors, add first-class connectors.

### Deliverables

* **API freeze window** (4 weeks): only doc/bench/test changes
* **Ecosystem adapters** (best-effort): Arrow/Parquet writer crate prototype,
  Kafka example pipeline
* **Support policy**: 6-month minor support window; security patches anytime

### Exit Criteria

* Changelog & README carry a "**Stability Guarantees**" section
* Example integrations build in CI; round-trip and perf budgets still
  satisfied

---

## Telemetry Rollout (Phase 6)

**Status:** Done â€” staging exporter live; dashboards + alerts active.

**Why:** make runtime behavior observable with a rollback lever.

### Plan

* [x] Feature-gate metrics; exporter behind `--metrics-listen`
* [x] Emit low-cardinality series in decode path
* [x] README + Library API docs
* [x] Staging rollout (enable flag; Prom scrape)
* [x] Dashboards (QPS, bytes/s, error rate, MiB/s)
* [x] Alerts (error burst, throughput drop)
* [x] Perf sanity on staging (MiB/s, RSS in-band)

**Exit:** `/metrics` reachable; Prom scraping; dashboards green; SLO receipts
steady; builds clean with/without metrics.

---

## Project board & labels

* **Board columns**: Backlog â†’ In Progress â†’ In Review â†’ Bench Verified â†’
  Done
* **Labels**: `area:parser`, `area:bench`, `area:docs`, `type:feature`,
  `type:bug`, `type:tests`, `perf:budget-regression`
* **Rules**:
  * Anything touching hot paths must pass **Bench Verified** before **Done**
  * Any PR adding perf numbers must **not** repeat themâ€”link to canonical
    section

---

## Release train

* **Minor**: every 6â€“8 weeks (feature batches)
* **Patch**: as-needed (bug or doc only)
* **Pre-release checklist**: `cargo build -r` â€¢ `nextest` â€¢ `bench receipts`
  â€¢ link check â€¢ changelog â€¢ tag â€¢ GitHub release

---

## Owner matrix (example; edit as you like)

| Area              | DRI        | Backup     |
| ----------------- | ---------- | ---------- |
| Parser & dialects | @you       | @contrib-A |
| Codec & perf      | @you       | @contrib-B |
| CLI & docs        | @contrib-C | @you       |
| CI/bench receipts | @contrib-D | @contrib-C |

---

## Paste-ready CI snippets

### Bench receipts (GitHub Actions)

```yaml
- name: Run benches
  run: |
    PERF=1 cargo bench -p copybook-bench \
      -- --output-format bencher | tee bench.out

- name: Roll up perf JSON
  run: |
    python3 - << 'PY'
    import json,glob
    from pathlib import Path
    reports=list(
      glob.glob('target/criterion/**/new/benchmark.json',
      recursive=True))
    out={"display_mib_per_s":None,"comp3_mib_per_s":None}
    # Parse actual metric keys and set SLOs (implementation detail)
    Path('perf.json').write_text(json.dumps(out))
    PY

- name: Upload artifacts
  uses: actions/upload-artifact@v4
  with:
    name: bench-artifacts
    path: |
      perf.json
      target/criterion/**
    retention-days: 14

- name: Comment perf summary
  if: ${{ github.event_name == 'pull_request' }}
  run: |
    gh pr comment ${{ github.event.pull_request.number }} \
      --body "$(cat perf.json)"
```

### SLO gate (simple)

```yaml
- name: Enforce SLOs
  run: |
    python3 - << 'PY'
    import json,sys
    with open('perf.json') as fh:
        data=json.load(fh)
    if data.get("display_mib_per_s",0) < 80:
        sys.exit("DISPLAY throughput below 80 MiB/s floor")
    if data.get("comp3_mib_per_s",0) < 40:
        sys.exit("COMP-3 throughput below 40 MiB/s floor")
    PY
```

---

## Technical Debt Tracking (Dec 2024 Audit)

The following items were identified during comprehensive codebase exploration
and are tracked for future sprints:

### Documentation (Medium Priority)

* [ ] Document 22 numeric functions in `copybook-codec/src/numeric.rs`
* [ ] Add API documentation for memory module (`ScratchBuffers`,
  `SequenceRing`, `WorkerPool`)
* [ ] Add usage examples to iterator module public functions

### Test Coverage (Future Sprints)

* [ ] Add dedicated tests for 9 untested error codes (CBKS701-703,
  CBKD101, CBKE510/515, CBKF102/104, CBKI001)
* [ ] Add unit tests for memory/iterator infrastructure
* [ ] Improve audit feature test coverage (currently ~10%)

### Code Quality (Completed in v0.4.0+)

* [x] Consolidate CLI command duplication (`parse_selectors`, `ParseOptions`,
  field projection)
* [x] Fix deprecated `cargo_bin` function in xtask tests
* [x] Standardize workspace dependency inheritance (`sha2`, `chrono` in
  `copybook-gen`)
* [x] **Production panics at 0** on main (test-only panics remain acceptable) â€” PR #182
* [x] **E3.1 Edited PIC Encoding** for numeric fields â€” commit 976ca0f
* [x] **D0 Dialect Lever Contract** with comprehensive tests â€” commit a9609af
* [x] **N1 Nested ODO Design** with O5/O6 rejection â€” PR #172

### CI Mode (Current)

* **CI-off operating mode**: Local gates + small PRs + explicit receipts in PR bodies
* **Dispatch-only workflows**: Mutants, fuzz, SBOM are dispatch-only until CI is re-enabled
* **Manual validation**: Run workflows once when CI returns to validate artifact upload paths and runtime budgets

### Distribution

* **crates.io** = Public artifact distribution (crate tarball becomes public)
* **Internal/Private distribution**: Git tags on private repositories, private cargo registries
* **Note**: `cargo publish --dry-run` for workspace crates may fail for codec/cli prior to publishing core/codec (verification builds in isolation). Use `cargo package --no-verify` to inspect tarball contents.

---

## Definition of Done (all milestones)

* âœ… Tests green (unit/integration/golden fixtures)
* âœ… Bench receipts uploaded; budgets respected
* âœ… Docs updated (no duplicated performance figures)
* âœ… Changelog entry & tag created
## License

Licensed under **AGPL-3.0-or-later**. See [LICENSE](LICENSE).
